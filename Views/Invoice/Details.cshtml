@model PesticideShop.Models.Invoice

@{
    ViewData["Title"] = "ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©";
    var totalAmount = Model.TotalAmount; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø®Ø²Ù† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    var isExchange = Model.Type == InvoiceType.Exchange;
    var isReturn = Model.Type == InvoiceType.Return;
    var isSale = Model.Type == InvoiceType.Sale;
    var remaining = Model.RemainingAmount; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„Ù…Ø®Ø²Ù†
    var actualRemaining = Math.Abs(totalAmount) - Model.AmountPaid;
}



<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            @if (isExchange)
            {
                
                <span class="text-info">ÙØ§ØªÙˆØ±Ø© Ø§Ø³ØªØ¨Ø¯Ø§Ù„</span>
            }
            else if (isReturn)
            {
                
                <span class="text-warning">ÙØ§ØªÙˆØ±Ø© Ø¥Ø±Ø¬Ø§Ø¹</span>
            }
            else
            {
                
                <span class="text-success">ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</span>
            }
            #@Model.InvoiceNumber
        </h2>
        <div>
            <a asp-action="Index" asp-controller="Invoices" class="btn btn-outline-secondary">
                â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙÙˆØ§ØªÙŠØ±
            </a>
            @if (Model.CustomerId > 0)
            {
                <a asp-controller="Customers" asp-action="Details" asp-route-id="@Model.CustomerId" class="btn btn-outline-primary">
                    ğŸ‘¤ Ù…Ù„Ù Ø§Ù„Ø¹Ù…ÙŠÙ„
                </a>
            }
            <button onclick="window.print()" class="btn btn-info">
                ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©
            </button>
        </div>
    </div>

    <!-- Invoice Info Card -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        
                        Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong>
                        </div>
                        <div class="col-6">
                            @Model.InvoiceNumber
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <strong>Ø§Ù„Ù†ÙˆØ¹:</strong>
                        </div>
                        <div class="col-6">
                            @if (isExchange)
                            {
                                <span class="badge bg-info">Ø§Ø³ØªØ¨Ø¯Ø§Ù„</span>
                            }
                            else if (isReturn)
                            {
                                <span class="badge bg-warning">Ø¥Ø±Ø¬Ø§Ø¹</span>
                            }
                            else
                            {
                                <span class="badge bg-success">Ø¨ÙŠØ¹</span>
                            }
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong>
                        </div>
                        <div class="col-6">
                            @Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                        </div>
                    </div>
                    <hr>
                    @{
                        // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                        var shouldShowCashier = isSale || isReturn || isExchange;
                        var cashierName = Model.CashierName;
                        
                        // Ø­Ù„ Ø¨Ø¯ÙŠÙ„: Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø´ÙŠØ±ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                        if (string.IsNullOrEmpty(cashierName))
                        {
                            cashierName = User.Identity?.Name ?? "Ù†Ø¸Ø§Ù…";
                        }
                    }
                    @if (shouldShowCashier && !string.IsNullOrEmpty(cashierName))
                    {
                        <div class="row">
                            <div class="col-6">
                                <strong>Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø´ÙŠØ±:</strong>
                            </div>
                            <div class="col-6">
                                @cashierName
                            </div>
                        </div>
                        <hr>
                    }
                    <div class="row">
                        <div class="col-6">
                            <strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹:</strong>
                        </div>
                        <div class="col-6">
                            @switch (Model.Status)
                            {
                                case InvoiceStatus.Paid:
                                    <span class="badge bg-success">Ù…Ø¯ÙÙˆØ¹</span>
                                    break;
                                case InvoiceStatus.PartiallyPaid:
                                    <span class="badge bg-warning">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹</span>
                                    break;
                                case InvoiceStatus.Draft:
                                    <span class="badge bg-secondary">ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨</span>
                                    break;
                                case InvoiceStatus.Overdue:
                                    <span class="badge bg-danger">Ù…ØªØ£Ø®Ø±</span>
                                    break;
                                case InvoiceStatus.Cancelled:
                                    <span class="badge bg-dark">Ù…Ù„ØºÙŠ</span>
                                    break;
                            }
                        </div>
                    </div>
                    @if (Model.ShippingType.HasValue)
                    {
                        <hr>
                        <div class="row">
                            <div class="col-6">
                                <strong>Ù†ÙˆØ¹ Ø§Ù„Ø´Ø­Ù†:</strong>
                            </div>
                            <div class="col-6">
                                @switch (Model.ShippingType.Value)
                                {
                                    case PesticideShop.Models.ShippingType.Bosta:
                                        <span class="badge bg-primary">ğŸ“¦ Ø¨ÙˆØ³Ø·Ø§</span>
                                        break;
                                    case PesticideShop.Models.ShippingType.Cairo:
                                        <span class="badge bg-info">ğŸš› ÙƒØ§ÙŠØ±Ùˆ</span>
                                        break;
                                    case PesticideShop.Models.ShippingType.NoShipping:
                                        <span class="badge bg-secondary">âŒ Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†</span>
                                        break;
                                    default:
                                        <span class="badge bg-light text-dark">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
                                        break;
                                }
                            </div>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Model.Notes))
                    {
                        <hr>
                        <div class="row">
                            <div class="col-6">
                                <strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong>
                            </div>
                            <div class="col-6">
                                @Model.Notes
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        
                        Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.Customer != null)
                    {
                        <div class="row">
                            <div class="col-6">
                                <strong>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong>
                            </div>
                            <div class="col-6">
                                @Model.Customer.Name
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-6">
                                <strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong>
                            </div>
                            <div class="col-6">
                                @Model.Customer.PhoneNumber
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.Customer.Address))
                        {
                            <hr>
                            <div class="row">
                                <div class="col-6">
                                    <strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong>
                                </div>
                                <div class="col-6">
                                    @Model.Customer.Address
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted">
                           
                            Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø­Ø¯Ø¯
                        </p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Items Table -->
    <div class="card">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
             
                ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù
            </h5>
        </div>
        <div class="card-body">
            @if (Model.Items?.Any() == true)
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Items)
                            {
                                <tr class="@(item.Quantity < 0 ? "table-warning" : "")">
                                    <td>
                                        <div class="fw-bold">@item.Product?.Name</div>
                                        @{
                                            // Get product default color and size
                                            var productDefaultColor = item.Product?.Color ?? "";
                                            var productDefaultSize = item.Product?.Size.ToString() ?? "";
                                            
                                            // Check if custom color/size was selected (different from default)
                                            var isCustomColor = !string.IsNullOrEmpty(item.Color) && item.Color != productDefaultColor;
                                            var isCustomSize = !string.IsNullOrEmpty(item.Size) && item.Size != productDefaultSize;
                                            
                                            // Display color and size
                                            var displayColor = !string.IsNullOrEmpty(item.Color) ? item.Color : productDefaultColor;
                                            var displaySize = !string.IsNullOrEmpty(item.Size) ? item.Size : productDefaultSize;
                                        }
                                        
                                        @if (!string.IsNullOrEmpty(displayColor) || !string.IsNullOrEmpty(displaySize))
                                        {
                                            <div class="mt-1">
                                                @if (!string.IsNullOrEmpty(displayColor))
                                                {
                                                    <span class="badge @(isCustomColor ? "bg-warning" : "bg-info") badge-sm" title="@(isCustomColor ? "Ù„ÙˆÙ† Ù…Ø®ØµØµ" : "Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ")">
                                                        ğŸ¨ @displayColor
                                                    </span>
                                                }
                                                @if (!string.IsNullOrEmpty(displaySize))
                                                {
                                                    <span class="badge @(isCustomSize ? "bg-warning" : "bg-secondary") badge-sm" title="@(isCustomSize ? "Ù…Ù‚Ø§Ø³ Ù…Ø®ØµØµ" : "Ø§Ù„Ù…Ù‚Ø§Ø³ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ")">
                                                        ğŸ“ @displaySize
                                                    </span>
                                                }
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        @if (item.Quantity < 0)
                                        {
                                            <span class="text-warning">
                                               
                                                @Math.Abs(item.Quantity)
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-success">
                                               
                                                @item.Quantity
                                            </span>
                                        }
                                    </td>
                                    <td>@item.UnitPrice.ToString("N2") Ø¬.Ù…</td>
                                    <td>
                                        @{
                                            var itemTotal = item.Quantity * item.UnitPrice;
                                        }
                                        @if (itemTotal < 0)
                                        {
                                            <span class="text-warning">(@Math.Abs(itemTotal).ToString("N2")) Ø¬.Ù…</span>
                                        }
                                        else
                                        {
                                            <span class="text-success">@itemTotal.ToString("N2") Ø¬.Ù…</span>
                                        }
                                    </td>
                                    <td>
                                        @if (item.Quantity < 0)
                                        {
                                            @if (isReturn)
                                            {
                                                <span class="badge bg-warning">Ø¥Ø±Ø¬Ø§Ø¹</span>
                                            }
                                            else if (isExchange)
                                            {
                                                <span class="badge bg-info">Ù…Ù†ØªØ¬ Ù…ÙØ³ØªØ±Ø¬Ø¹</span>
                                            }
                                        }
                                        else
                                        {
                                            @if (isExchange)
                                            {
                                                <span class="badge bg-success">Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-primary">Ø¨ÙŠØ¹</span>
                                            }
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center text-muted py-4">
                  
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</p>
                </div>
            }
        </div>
    </div>

    <!-- Summary Card -->
    <div class="row mt-4">
        <div class="col-md-6 offset-md-6">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calculator"></i>
                        Ù…Ù„Ø®Øµ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong>
                        </div>
                        <div class="col-6">
                            @if (totalAmount < 0)
                            {
                                <span class="text-warning">(@Math.Abs(totalAmount).ToString("N2")) Ø¬.Ù…</span>
                            }
                            else
                            {
                                <span class="text-success">@totalAmount.ToString("N2") Ø¬.Ù…</span>
                            }
                        </div>
                    </div>
                    
                    @if (Model.AmountPaid > 0)
                    {
                        <hr>
                        <div class="row">
                            <div class="col-6">
                                <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong>
                            </div>
                            <div class="col-6">
                                <span class="text-info">@Model.AmountPaid.ToString("N2") Ø¬.Ù…</span>
                            </div>
                        </div>
                        
                        @if (remaining > 0)
                        {
                            <hr>
                            <div class="row">
                                <div class="col-6">
                                    <strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong>
                                </div>
                                <div class="col-6">
                                    <span class="text-danger">@remaining.ToString("N2") Ø¬.Ù…</span>
                                </div>
                            </div>
                        }
                        else if (remaining < 0)
                        {
                            @if (totalAmount < 0)
                            {
                                <!-- ÙØ§ØªÙˆØ±Ø© Ø¥Ø±Ø¬Ø§Ø¹ Ø£Ùˆ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨ØµØ§ÙÙŠ Ø³Ø§Ù„Ø¨ -->
                                <hr>
                                <div class="row">
                                    <div class="col-6">
                                        <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ù„Ù„Ø¹Ù…ÙŠÙ„:</strong>
                                    </div>
                                    <div class="col-6">
                                        <span class="text-warning">@Math.Abs(totalAmount).ToString("N2") Ø¬.Ù…</span>
                                    </div>
                                </div>
                                
                                @if (isExchange)
                                {
                                    <!-- ÙØ§ØªÙˆØ±Ø© Ø§Ø³ØªØ¨Ø¯Ø§Ù„ - Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¯ÙØ¹ ÙØ±Ù‚ Ø§Ù„Ø³Ø¹Ø± -->
                                    <hr>
                                    <div class="row">
                                        <div class="col-6">
                                            <strong>ÙØ±Ù‚ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong>
                                        </div>
                                        <div class="col-6">
                                            <span class="text-info">@Model.AmountPaid.ToString("N2") Ø¬.Ù…</span>
                                        </div>
                                    </div>
                                    
                                    @if (actualRemaining > 0)
                                    {
                                        <hr>
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯:</strong>
                                            </div>
                                            <div class="col-6">
                                                <span class="text-warning">@actualRemaining.ToString("N2") Ø¬.Ù…</span>
                                            </div>
                                        </div>
                                    }
                                    else if (actualRemaining < 0)
                                    {
                                        <hr>
                                        <div class="row">
                                            <div class="col-6">
                                                <strong class="text-danger">Ø®Ø·Ø£: Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¯ÙØ¹ Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨!</strong>
                                            </div>
                                            <div class="col-6">
                                                <span class="text-danger">@Math.Abs(actualRemaining).ToString("N2") Ø¬.Ù…</span>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <!-- ÙØ§ØªÙˆØ±Ø© Ø¥Ø±Ø¬Ø§Ø¹ Ø¹Ø§Ø¯ÙŠØ© - Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙØ¹ -->
                                    <hr>
                                    <div class="row">
                                        <div class="col-6">
                                            <strong class="text-danger">Ø®Ø·Ø£: Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¯ÙØ¹ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯!</strong>
                                        </div>
                                        <div class="col-6">
                                            <span class="text-danger">@(Model.AmountPaid + Math.Abs(totalAmount)).ToString("N2") Ø¬.Ù…</span>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <!-- ÙØ§ØªÙˆØ±Ø© Ø¹Ø§Ø¯ÙŠØ© Ø¨ÙØ§Ø¦Ø¶ Ø¯ÙØ¹ -->
                                <hr>
                                <div class="row">
                                    <div class="col-6">
                                        <strong>ÙØ§Ø¦Ø¶ Ø§Ù„Ø¯ÙØ¹:</strong>
                                    </div>
                                    <div class="col-6">
                                        <span class="text-success">@Math.Abs(remaining).ToString("N2") Ø¬.Ù…</span>
                                    </div>
                                </div>
                            }
                        }
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Exchange/Return specific info -->
    @if (isExchange)
    {
        <div class="alert alert-info mt-4">
            <h5>
            
                Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
            </h5>
            <p class="mb-0">
                Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØªÙ…Ø«Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…Ù†ØªØ¬. 
                Ø§Ù„Ø£ØµÙ†Ø§Ù Ø°Ø§Øª Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø³Ø§Ù„Ø¨Ø© ØªÙ…Ø«Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙØ³ØªØ±Ø¬Ø¹Ø©ØŒ 
                ÙˆØ§Ù„Ø£ØµÙ†Ø§Ù Ø°Ø§Øª Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ÙˆØ¬Ø¨Ø© ØªÙ…Ø«Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.
            </p>
        </div>
    }
    
    @if (isReturn)
    {
        <div class="alert alert-warning mt-4">
            <h5>
             
                Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
            </h5>
            <p class="mb-0">
                Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØªÙ…Ø«Ù„ Ø¹Ù…Ù„ÙŠØ© Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ù†ØªØ¬Ø§Øª. 
                Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø³Ø§Ù„Ø¨Ø© Ù„Ø£Ù†Ù‡Ø§ ØªÙ…Ø«Ù„ Ø£ØµÙ†Ø§Ù Ù…ÙØ³ØªØ±Ø¬Ø¹Ø© Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„.
            </p>
        </div>
    }
</div>

<style>
    @@media print {
        .btn, .alert {
            display: none !important;
        }
        
        .card {
            border: 1px solid #000 !important;
            page-break-inside: avoid;
        }
        
        .table {
            border: 1px solid #000 !important;
        }
        
        .table th, .table td {
            border: 1px solid #000 !important;
        }
    }
</style>



