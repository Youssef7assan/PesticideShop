@model PesticideShop.Models.Invoice

@{
    ViewData["Title"] = "ÙØ§ØªÙˆØ±Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©";
    Layout = null;
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ
    var subtotal = Model.Items?.Sum(i => i.Quantity * i.UnitPrice) ?? 0;
    
    // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙ…
    var totalDiscount = Model.Items?.Sum(i => i.Discount) ?? 0;
    
    // Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù†
    var shippingCost = Model.ShippingCost;
    
    // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… ÙˆØ§Ù„Ø´Ø­Ù†
    var finalTotal = subtotal - totalDiscount + shippingCost;
    
    // Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
    var remaining = finalTotal - Model.AmountPaid;
    
    var isExchange = Model.Type == InvoiceType.Exchange;
    var isReturn = Model.Type == InvoiceType.Return;
    var isSale = Model.Type == InvoiceType.Sale;
    
    // Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø¥Ù„Ù‰ Ù†Øµ Ø¹Ø±Ø¨ÙŠ
    string GetPaymentMethodDisplayName(string paymentMethod)
    {
        return paymentMethod switch
        {
            "cash" => "Ù†Ù‚Ø¯Ø§Ù‹",
            "visa" => "ÙÙŠØ²Ø§",
            "instapay" => "Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ",
            "wallet" => "Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©",
            "delivery" => "Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…",
            _ => paymentMethod
        };
    }
}

<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù validation Ø§Ù„Ù‡Ø§ØªÙ -->
    <script src="~/js/phoneValidation.js"></script>
    <style>
        /* Print Optimization - Single Page */
        @@media print {
            @@page {
                margin: 0.5cm;
                size: A4;
            }
            
            body { 
                margin: 0 !important; 
                padding: 0 !important; 
                font-size: 10px !important;
                line-height: 1.2 !important;
            }
            
            .invoice-container { 
                max-width: 100% !important; 
                margin: 0 !important; 
                box-shadow: none !important;
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
                page-break-before: avoid !important;
            }
            
            .invoice-header { 
                padding: 8px !important; 
                margin-bottom: 5px !important;
            }
            
            .invoice-number { font-size: 1.2rem !important; margin-bottom: 3px !important; }
            .invoice-type { font-size: 0.9rem !important; }
            
            .company-info { 
                margin-bottom: 5px !important; 
                padding: 8px !important;
            }
            
            .company-name { font-size: 1.2rem !important; margin-bottom: 2px !important; }
            .company-details { font-size: 0.7rem !important; }
            
            .customer-info { 
                padding: 8px !important; 
                margin-bottom: 8px !important;
            }
            
            .items-table { 
                margin-bottom: 10px !important;
                page-break-inside: avoid !important;
            }
            
            .table th, .table td { 
                padding: 2px 3px !important; 
                font-size: 9px !important;
                line-height: 1.1 !important;
            }
            
            .table th { font-size: 9px !important; }
            
            .summary-section { 
                margin-bottom: 8px !important;
                padding: 8px !important;
            }
            
            .summary-row { 
                margin-bottom: 3px !important; 
                font-size: 9px !important;
            }
            
            .footer { 
                margin-top: 5px !important;
                padding: 8px !important;
            }
            
            .footer h6 { font-size: 9px !important; margin-bottom: 3px !important; }
            .footer p { font-size: 8px !important; margin-bottom: 2px !important; }
            
            .alert { 
                padding: 5px !important; 
                margin-bottom: 5px !important;
            }
            
            .alert h6 { font-size: 9px !important; margin-bottom: 2px !important; }
            .alert p { font-size: 8px !important; }
            
            .badge { 
                font-size: 8px !important; 
                padding: 1px 3px !important;
            }
            
            .btn, .no-print { 
                display: none !important; 
            }
            
            .compact-row { margin-bottom: 3px !important; }
            .compact-text { font-size: 8px !important; margin-bottom: 1px !important; }
            
            /* Force single page */
            html, body { height: 100% !important; }
            .invoice-container { height: auto !important; min-height: auto !important; }
            
            /* Policy visibility rules */
            .policy-container {
                display: none !important; /* Hide policy by default when printing */
            }
            body.printing-policy .policy-container { 
                display: block !important; 
                max-width: 100% !important; 
                margin: 0 !important; 
                box-shadow: none !important;
                page-break-inside: avoid !important;
            }
            
            .policy-header { 
                padding: 10px !important; 
                margin-bottom: 8px !important;
                background: #f8f9fa !important;
                border: 2px solid #333 !important;
            }
            
            .policy-number { 
                font-size: 1.4rem !important; 
                font-weight: bold !important;
                text-align: center !important;
                margin-bottom: 5px !important;
            }
            
            .policy-company { 
                font-size: 1.1rem !important; 
                text-align: center !important;
                margin-bottom: 3px !important;
            }
            
            .policy-details { 
                font-size: 0.8rem !important; 
                text-align: center !important;
            }
            
            .policy-customer { 
                padding: 8px !important; 
                margin-bottom: 8px !important;
                border: 1px solid #333 !important;
            }
            
            .policy-items { 
                margin-bottom: 8px !important;
                page-break-inside: avoid !important;
            }
            
            .policy-table th, .policy-table td { 
                padding: 3px 4px !important; 
                font-size: 10px !important;
                border: 1px solid #333 !important;
            }
            
            .policy-table th { 
                background-color: #f8f9fa !important; 
                font-weight: bold !important;
            }
            
            .policy-footer { 
                margin-top: 8px !important;
                padding: 8px !important;
                text-align: center !important;
                border-top: 2px solid #333 !important;
            }
        }
        
        /* Policy Container - Hidden by default */
        .policy-container {
            display: none;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 800px;
            padding: 0;
            min-height: auto;
            height: auto;
        }
        
        .policy-header {
            background: #f8f9fa;
            padding: 15px;
            text-align: center;
            border: 2px solid #333;
        }
        
        .policy-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .policy-company {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .policy-details {
            color: #666;
            font-size: 0.9rem;
        }
        
        .policy-customer {
            background: #f8f9fa;
            padding: 10px;
            border: 1px solid #333;
            margin-bottom: 10px;
        }
        
        .policy-items {
            margin-bottom: 15px;
        }
        
        .policy-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .policy-table th {
            background-color: #f8f9fa;
            color: #2c3e50;
            font-size: 0.9rem;
            padding: 8px 6px;
            border: 1px solid #333;
            text-align: center;
        }
        
        .policy-table td {
            font-size: 0.9rem;
            padding: 6px 4px;
            border: 1px solid #333;
            vertical-align: middle;
        }
        
        .policy-footer {
            background: #f8f9fa;
            padding: 10px;
            text-align: center;
            border-top: 2px solid #333;
            font-size: 0.85rem;
        }
        
        /* Print Policy Specific Styles */
        body.printing-policy .invoice-container {
            display: none !important;
        }
        
        body.printing-policy .policy-container {
            display: block !important;
            margin: 0 !important;
            box-shadow: none !important;
        }
        
        body.printing-policy .no-print {
            display: none !important;
        }
        
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .invoice-container {
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 800px;
            padding: 0;
            /* Ensure single page layout */
            min-height: auto;
            height: auto;
        }
        
        .invoice-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .invoice-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .invoice-type {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .company-info {
            text-align: center;
            margin-bottom: 10px;
            padding: 10px;
        }
        
        .company-name {
            font-size: 1.6rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .company-details {
            color: #666;
            font-size: 0.9rem;
        }
        
        .customer-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .items-table {
            margin-bottom: 15px;
        }
        
        .table th {
            background-color: #343a40;
            color: white;
            font-size: 0.9rem;
            padding: 8px 6px;
        }
        
        .table td {
            font-size: 0.9rem;
            padding: 6px 4px;
            vertical-align: middle;
        }
        
        .summary-section {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .summary-label {
            font-weight: bold;
            color: #495057;
        }
        
        .summary-value {
            color: #2c3e50;
        }
        
        .total-row {
            border-top: 2px solid #dee2e6;
            padding-top: 8px;
            margin-top: 8px;
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .footer {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.85rem;
        }
        
        .footer h6 {
            color: #495057;
            margin-bottom: 8px;
        }
        
        .footer p {
            margin-bottom: 4px;
            color: #666;
        }
        
        .badge {
            font-size: 0.8rem;
            padding: 3px 6px;
        }
        
        .alert {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
        }
        
        .alert h6 {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .alert p {
            margin-bottom: 0;
            font-size: 0.85rem;
        }
        
        /* Compact layout for print */
        .compact-row {
            margin-bottom: 8px;
        }
        
        .compact-col {
            padding: 0 5px;
        }
        
        .compact-text {
            font-size: 0.8rem;
            margin-bottom: 2px;
        }
    </style>
</head>
<body>
    <div class="invoice-container">
        <!-- Header -->
        <div class="invoice-header">
            <div class="invoice-number">ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…: @Model.InvoiceNumber</div>
            <div class="invoice-type">
                @if (isSale)
                {
                    <span>ğŸ›’ ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</span>
                }
                else if (isReturn)
                {
                    <span>â†©ï¸ ÙØ§ØªÙˆØ±Ø© Ø¥Ø±Ø¬Ø§Ø¹</span>
                }
                else if (isExchange)
                {
                    <span>ğŸ”„ ÙØ§ØªÙˆØ±Ø© Ø§Ø³ØªØ¨Ø¯Ø§Ù„</span>
                }
            </div>
        </div>

        <!-- Company Info -->
        <div class="company-info">
            <div class="company-name"> Pharaonic</div>
            <div class="company-details">
                <div>01125011078 / 01015625250</div>
                <div>www.bypharaonic.com</div>
                
            </div>
        </div>

        <!-- Customer Info -->
        <div class="customer-info">
            <div class="row">
                <div class="col-md-6">
                    <strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> @Model.Customer?.Name<br>
                    <strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> @Model.Customer?.PhoneNumber<br>
                  
                    @if (!string.IsNullOrEmpty(Model.Customer?.AdditionalPhone))
                    {
                        <strong>Ù‡Ø§ØªÙ Ø¥Ø¶Ø§ÙÙŠ:</strong> @Model.Customer.AdditionalPhone<br>
                    }
                </div>
                <div class="col-md-6">
                    @if (!string.IsNullOrEmpty(Model.Customer?.Governorate))
                    {
                        <strong>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> @Model.Customer.Governorate<br>
                    }
                    @{
                        var parts = new List<string>();
                        if (!string.IsNullOrEmpty(Model.Customer?.Governorate)) parts.Add(Model.Customer.Governorate);
                        if (!string.IsNullOrEmpty(Model.Customer?.District)) parts.Add(Model.Customer.District);
                        if (!string.IsNullOrEmpty(Model.Customer?.DetailedAddress)) parts.Add(Model.Customer.DetailedAddress);
                        var fullAddress = string.Join(" - ", parts);
                    }
                    @if (!string.IsNullOrWhiteSpace(fullAddress))
                    {
                        <strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„:</strong> @fullAddress<br>
                    }
                </div>
            </div>
            <!-- Policy Print Button -->
            <div class="text-center mt-3 no-print">
                <button onclick="printPolicy()" class="btn btn-info btn-sm">
                    ğŸ“„ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ©
                </button>
            </div>
        </div>

        <!-- Invoice Details -->
        <div class="container-fluid">
            <div class="row compact-row">
                <div class="col-md-3 compact-col">
                    <div class="compact-text"><strong>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong></div>
                    <div>@Model.InvoiceDate.ToString("dd/MM/yyyy")</div>
                </div>
                <div class="col-md-3 compact-col">
                    <div class="compact-text"><strong>â° Ø§Ù„ÙˆÙ‚Øª:</strong></div>
                    <div>@Model.InvoiceDate.ToString("HH:mm")</div>
                </div>
                <div class="col-md-3 compact-col">
                    <div class="compact-text"><strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong></div>
                    <div>@GetPaymentMethodDisplayName(Model.PaymentMethod ?? "")</div>
                </div>
                <div class="col-md-3 compact-col">
                    <div class="compact-text"><strong>Ù…ØµØ¯Ø± Ø§Ù„Ø·Ù„Ø¨:</strong></div>
                    <div>
                        @switch (Model.OrderOrigin)
                        {
                            case PesticideShop.Models.OrderOrigin.Website:
                                <span>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</span>
                                break;
                            case PesticideShop.Models.OrderOrigin.Instagram:
                                <span>ğŸ“· Ø§Ù†Ø³ØªØ¬Ø±Ø§Ù…</span>
                                break;
                            case PesticideShop.Models.OrderOrigin.Facebook:
                                <span>ğŸ“˜ ÙÙŠØ³Ø¨ÙˆÙƒ</span>
                                break;
                            case PesticideShop.Models.OrderOrigin.WhatsApp:
                                <span>ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</span>
                                break;
                            case PesticideShop.Models.OrderOrigin.Phone:
                                <span>Ù‡Ø§ØªÙ</span>
                                break;
                            case PesticideShop.Models.OrderOrigin.WalkIn:
                                <span>ğŸš¶ Ø­Ø¶ÙˆØ± Ø´Ø®ØµÙŠ</span>
                                break;
                            case PesticideShop.Models.OrderOrigin.PhysicalStore:
                                <span>ğŸª Ù…ØªØ¬Ø± ÙØ¹Ù„ÙŠ</span>
                                break;
                            case PesticideShop.Models.OrderOrigin.Other:
                                <span>ğŸ”— Ø£Ø®Ø±Ù‰</span>
                                break;
                            default:
                                <span>â“ ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
                                break;
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Items Table -->
        <div class="items-table">
            <table class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th class="text-center">#</th>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th class="text-center">Ø§Ù„Ù„ÙˆÙ†/Ø§Ù„Ù…Ù‚Ø§Ø³</th>
                        <th class="text-center">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th class="text-center">Ø§Ù„Ø³Ø¹Ø±</th>
                        <th class="text-center">Ø§Ù„Ø®ØµÙ…</th>
                        <th class="text-center">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Items != null)
                    {
                        var itemNumber = 1;
                        foreach (var item in Model.Items)
                        {
                            var itemTotal = (item.Quantity * item.UnitPrice) - item.Discount;
                            <tr>
                                <td class="text-center">@itemNumber</td>
                                <td>
                                    <div><strong>@item.Product?.Name</strong></div>
                                    @if (!string.IsNullOrEmpty(item.Product?.QRCode))
                                    {
                                        <small class="text-muted">QR: @item.Product.QRCode</small>
                                    }
                                </td>
                                <td class="text-center">
                                    @{
                                        // Get product default color and size
                                        var productDefaultColor = item.Product?.Color ?? "";
                                        var productDefaultSize = item.Product?.Size.ToString() ?? "";
                                        
                                        // Check if custom color/size was selected (different from default)
                                        var isCustomColor = !string.IsNullOrEmpty(item.Color) && item.Color != productDefaultColor;
                                        var isCustomSize = !string.IsNullOrEmpty(item.Size) && item.Size != productDefaultSize;
                                        
                                        // Display color and size
                                        var displayColor = !string.IsNullOrEmpty(item.Color) ? item.Color : productDefaultColor;
                                        var displaySize = !string.IsNullOrEmpty(item.Size) ? item.Size : productDefaultSize;
                                    }
                                    
                                    @if (!string.IsNullOrEmpty(displayColor) || !string.IsNullOrEmpty(displaySize))
                                    {
                                        @if (!string.IsNullOrEmpty(displayColor))
                                        {
                                            <div>
                                                <span class="badge @(isCustomColor ? "bg-warning" : "bg-info")" title="@(isCustomColor ? "Ù„ÙˆÙ† Ù…Ø®ØµØµ" : "Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ")">
                                                    ğŸ¨ @displayColor
                                                </span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(displaySize))
                                        {
                                            <div>
                                                <span class="badge @(isCustomSize ? "bg-warning" : "bg-secondary")" title="@(isCustomSize ? "Ù…Ù‚Ø§Ø³ Ù…Ø®ØµØµ" : "Ø§Ù„Ù…Ù‚Ø§Ø³ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ")">
                                                    ğŸ“ @displaySize
                                                </span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td class="text-center">@Math.Abs(item.Quantity)</td>
                                <td class="text-center">@item.UnitPrice.ToString("N2") Ø¬.Ù…</td>
                                <td class="text-center">
                                    @if (item.Discount > 0)
                                    {
                                        <span class="text-danger">@item.Discount.ToString("N2") Ø¬.Ù…</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td class="text-center"><strong>@itemTotal.ToString("N2") Ø¬.Ù…</strong></td>
                            </tr>
                            itemNumber++;
                        }
                    }
                </tbody>
            </table>
        </div>

        <!-- Summary Section -->
        <div class="summary-section">
            <div class="summary-row">
                <span class="summary-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</span>
                <span class="summary-value">@subtotal.ToString("N2") Ø¬.Ù…</span>
            </div>
            @if (totalDiscount > 0)
            {
                <div class="summary-row">
                    <span class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙ…:</span>
                    <span class="summary-value text-danger">-@totalDiscount.ToString("N2") Ø¬.Ù…</span>
                </div>
            }
            @if (shippingCost > 0)
            {
                <div class="summary-row">
                    <span class="summary-label">Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù†:</span>
                    <span class="summary-value">+@shippingCost.ToString("N2") Ø¬.Ù…</span>
                </div>
            }
            <div class="summary-row total-row">
                <span class="summary-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
                <span class="summary-value">@finalTotal.ToString("N2") Ø¬.Ù…</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span>
                <span class="summary-value text-success">@Model.AmountPaid.ToString("N2") Ø¬.Ù…</span>
            </div>
            @if (remaining > 0)
            {
                <div class="summary-row">
                    <span class="summary-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
                    <span class="summary-value text-warning">@remaining.ToString("N2") Ø¬.Ù…</span>
                </div>
            }
        </div>

        <!-- Special Notes -->
        @if (isExchange)
        {
            <div class="alert alert-info">
                <h6>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„</h6>
                <p class="mb-0">âœ… <strong>Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…ØªØ³Ø§ÙˆÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</strong></p>
            </div>
        }

        @if (isReturn)
        {
            <div class="alert alert-warning">
                <h6>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹</h6>
                <p class="mb-0">â†©ï¸ Ù‡Ø°Ù‡ ÙØ§ØªÙˆØ±Ø© Ø¥Ø±Ø¬Ø§Ø¹. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…ÙØ³ØªØ±Ø¬Ø¹Ø© Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„.</p>
            </div>
        }

        @if (!string.IsNullOrEmpty(Model.Notes))
        {
            <div class="alert alert-light">
                <h6>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h6>
                <p class="mb-0">@Model.Notes</p>
            </div>
        }

        <!-- Footer -->
        <div class="footer">
            <div class="row">
                
               
               
            </div>
            <hr>
            
            <p class="mb-1 text-center">Quality is our priority</p>
            
        </div>
    </div>

    <!-- Policy Container (Hidden by default) -->
    <div class="policy-container" id="policyContainer">
        <!-- Policy Header -->
        <div class="policy-header">
            <div class="policy-number">Ø¨ÙˆÙ„ÙŠØµØ© Ø±Ù‚Ù…: @Model.InvoiceNumber</div>
            <div class="policy-company">Pharaonic</div>
            <div class="policy-details">
                <div>01125011078 / 01015625250</div>
                <div>www.bypharaonic.com</div>
            </div>
        </div>

        <!-- Policy Customer Info -->
        <div class="policy-customer">
            <div class="row">
                <div class="col-md-6">
                    <strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> @Model.Customer?.Name<br>
                    <strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> @Model.Customer?.PhoneNumber<br>
                    @if (!string.IsNullOrEmpty(Model.Customer?.AdditionalPhone))
                    {
                        <strong>Ù‡Ø§ØªÙ Ø¥Ø¶Ø§ÙÙŠ:</strong> @Model.Customer.AdditionalPhone<br>
                    }
                </div>
                <div class="col-md-6">
                    @if (!string.IsNullOrEmpty(Model.Customer?.Governorate))
                    {
                        <strong>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> @Model.Customer.Governorate<br>
                    }
                    @{
                        var policyParts = new List<string>();
                        if (!string.IsNullOrEmpty(Model.Customer?.Governorate)) policyParts.Add(Model.Customer.Governorate);
                        if (!string.IsNullOrEmpty(Model.Customer?.District)) policyParts.Add(Model.Customer.District);
                        if (!string.IsNullOrEmpty(Model.Customer?.DetailedAddress)) policyParts.Add(Model.Customer.DetailedAddress);
                        var policyFullAddress = string.Join(" - ", policyParts);
                    }
                    @if (!string.IsNullOrWhiteSpace(policyFullAddress))
                    {
                        <strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„:</strong> @policyFullAddress<br>
                    }
                </div>
            </div>
        </div>

        <!-- Policy Items Table -->
        <div class="policy-items">
            <table class="policy-table">
                <thead>
                    <tr>
                        <th class="text-center">#</th>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th class="text-center">Ø§Ù„Ù„ÙˆÙ†/Ø§Ù„Ù…Ù‚Ø§Ø³</th>
                        <th class="text-center">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th class="text-center">Ø§Ù„Ø³Ø¹Ø±</th>
                        <th class="text-center">Ø§Ù„Ø®ØµÙ…</th>
                        <th class="text-center">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Items != null)
                    {
                        var itemNumber = 1;
                        foreach (var item in Model.Items)
                        {
                            var itemTotal = (item.Quantity * item.UnitPrice) - item.Discount;
                            <tr>
                                <td class="text-center">@itemNumber</td>
                                <td>
                                    <div><strong>@item.Product?.Name</strong></div>
                                    @if (!string.IsNullOrEmpty(item.Product?.QRCode))
                                    {
                                        <small class="text-muted">QR: @item.Product.QRCode</small>
                                    }
                                </td>
                                <td class="text-center">
                                    @{
                                        var productDefaultColor = item.Product?.Color ?? "";
                                        var productDefaultSize = item.Product?.Size.ToString() ?? "";
                                        var isCustomColor = !string.IsNullOrEmpty(item.Color) && item.Color != productDefaultColor;
                                        var isCustomSize = !string.IsNullOrEmpty(item.Size) && item.Size != productDefaultSize;
                                        var displayColor = !string.IsNullOrEmpty(item.Color) ? item.Color : productDefaultColor;
                                        var displaySize = !string.IsNullOrEmpty(item.Size) ? item.Size : productDefaultSize;
                                    }
                                    
                                    @if (!string.IsNullOrEmpty(displayColor) || !string.IsNullOrEmpty(displaySize))
                                    {
                                        @if (!string.IsNullOrEmpty(displayColor))
                                        {
                                            <div>
                                                <span class="badge @(isCustomColor ? "bg-warning" : "bg-info")">
                                                    @displayColor
                                                </span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(displaySize))
                                        {
                                            <div>
                                                <span class="badge @(isCustomSize ? "bg-warning" : "bg-secondary")">
                                                    @displaySize
                                                </span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td class="text-center">@Math.Abs(item.Quantity)</td>
                                <td class="text-center">@item.UnitPrice.ToString("N2") Ø¬.Ù…</td>
                                <td class="text-center">
                                    @if (item.Discount > 0)
                                    {
                                        <span class="text-danger">@item.Discount.ToString("N2") Ø¬.Ù…</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td class="text-center"><strong>@itemTotal.ToString("N2") Ø¬.Ù…</strong></td>
                            </tr>
                            itemNumber++;
                        }
                    }
                </tbody>
            </table>
        </div>

        @if (shippingCost > 0)
        {
            <div class="policy-summary" style="margin-top: 10px; display: flex; justify-content: flex-end; gap: 10px; font-weight: 700;">
                <span>Ø³Ø¹Ø± Ø§Ù„Ø´Ø­Ù†:</span>
                <span>@shippingCost.ToString("N2") Ø¬.Ù…</span>
            </div>
        }

        <!-- Policy Footer -->
        <div class="policy-footer">
            <div class="row">
                <div class="col-md-12 text-center">
                    <strong>Ù…Ø¨Ù„Øº Ø§Ù„ØªØ­ØµÙŠÙ„:</strong> @finalTotal.ToString("N2") Ø¬.Ù…
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons (Hidden on print) -->
    <div class="text-center mt-3 mb-3 no-print">
        <button onclick="window.print()" class="btn btn-primary btn-lg me-2">
            ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
        </button>
        <button onclick="sendInvoiceViaWhatsApp()" class="btn btn-success btn-lg me-2">
Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
        </button>
        <a href="javascript:history.back()" class="btn btn-secondary btn-lg">
            â† Ø±Ø¬ÙˆØ¹
        </a>
    </div>

    <script>
        // Auto-focus for printing
        window.addEventListener('load', function() {
            // Auto print if URL contains print parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('print') === 'true') {
                setTimeout(() => window.print(), 500);
            }
        });

        // Function to send invoice via WhatsApp
        function sendInvoiceViaWhatsApp() {
            try {
                // Get customer phone number
                const customerPhone = '@Model.Customer?.PhoneNumber';
                if (!customerPhone) {
                    alert('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©');
                    return;
                }

                // Show loading message
                alert('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨...');
                
                // Send WhatsApp message directly
                sendWhatsAppMessage(customerPhone).then((whatsappUrl) => {
                    // Open WhatsApp with message
                    window.open(whatsappUrl, '_blank');
                }).catch(error => {
                    console.error('Error sending WhatsApp message:', error);
                    alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨');
                });
                
            } catch (error) {
                console.error('Error sending invoice via WhatsApp:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨');
            }
        }

        // Function to send WhatsApp message
        async function sendWhatsAppMessage(phoneNumber) {
            try {
                const invoiceId = '@Model.Id';
                
                // Use fetch to get WhatsApp URL and open in new tab
                const response = await fetch(`/Invoice/SendWhatsApp/${invoiceId}`);
                const htmlContent = await response.text();
                
                // Create a temporary div to execute the script
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;
                document.body.appendChild(tempDiv);
                
                // Execute the script
                const script = tempDiv.querySelector('script');
                if (script) {
                    eval(script.textContent);
                }
                
                // Clean up
                document.body.removeChild(tempDiv);
                
            } catch (error) {
                console.error('Error sending WhatsApp message:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨: ' + error.message);
            }
        }


        // Fallback function for basic phone formatting
        function formatPhoneForWhatsAppBasic(phone) {
            if (!phone) return '';
            
            // Remove all non-digit characters
            let cleaned = phone.replace(/[^\d]/g, '');
            
            // Remove leading zeros
            while (cleaned.startsWith('0') && cleaned.length > 1) {
                cleaned = cleaned.substring(1);
            }
            
            // Add country code if not present
            if (cleaned.startsWith('20')) {
                return cleaned;
            } else if (cleaned.startsWith('1') && cleaned.length === 10) {
                return '20' + cleaned;
            } else if (cleaned.length === 9) {
                return '20' + cleaned;
            } else if (cleaned.length === 10) {
                return '20' + cleaned;
            } else if (cleaned.length === 11) {
                return cleaned;
            }
            
            // Default: assume Egypt
            return '20' + cleaned;
        }

        // Function to create invoice summary for WhatsApp
        function createInvoiceSummary() {
            const customerName = '@Model.Customer?.Name';
            const orderNumber = '@Model.OrderNumber';
            const invoiceDate = '@Model.InvoiceDate.ToString("dd/MM/yyyy")';
            const totalAmount = '@finalTotal.ToString("N2")';
            const itemsCount = '@(Model.Items?.Count ?? 0)';
            
            let message = `ğŸ‘” *Pharaonic* - ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©\n\n`;
            message += `ğŸ“‹ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: *${orderNumber}*\n`;
            message += `Ø§Ù„Ø¹Ù…ÙŠÙ„: *${customerName}*\n`;
            message += `ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: *${invoiceDate}*\n`;
            message += `ğŸ›ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù: *${itemsCount}*\n`;
            message += `ğŸ’° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: *${totalAmount} Ø¬.Ù…*\n\n`;
            
            // Add items summary
            message += `ğŸ“¦ *ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:*\n`;
            
            @if (Model.Items != null)
            {
                foreach (var item in Model.Items)
                {
                    <text>
                    message += `â€¢ @Html.Raw(item.Product?.Name) - Ø§Ù„ÙƒÙ…ÙŠØ©: @Math.Abs(item.Quantity) - Ø§Ù„Ø³Ø¹Ø±: @item.UnitPrice.ToString("N2") Ø¬.Ù…\n`;
                    </text>
                }
            }
            
            message += `\nğŸ“ Ù„Ù„ØªÙˆØ§ØµÙ„: 01125011078 / 01015625250\n`;
            message += `www.bypharaonic.com\n`;
            message += `\nØ´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§ ğŸ™`;
            
            return message;
        }

        // Function to print policy
        function printPolicy() {
            try {
                // Hide the main invoice container
                const invoiceContainer = document.querySelector('.invoice-container');
                const policyContainer = document.getElementById('policyContainer');
                
                if (!policyContainer) {
                    alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ©');
                    return;
                }
                
                // Store original display states
                const originalInvoiceDisplay = invoiceContainer.style.display;
                const originalPolicyDisplay = policyContainer.style.display;
                
                // Show policy and hide invoice
                invoiceContainer.style.display = 'none';
                policyContainer.style.display = 'block';
                
                // Add print-specific class to body
                document.body.classList.add('printing-policy');
                
                // Print
                window.print();
                
                // Restore original states after printing
                setTimeout(() => {
                    invoiceContainer.style.display = originalInvoiceDisplay;
                    policyContainer.style.display = originalPolicyDisplay;
                    document.body.classList.remove('printing-policy');
                }, 1000);
                
            } catch (error) {
                console.error('Error printing policy:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ©: ' + error.message);
            }
        }
    </script>
</body>
</html>
