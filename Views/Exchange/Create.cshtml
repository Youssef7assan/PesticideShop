@model PesticideShop.Controllers.ExchangeRequest

@{
    ViewData["Title"] = "Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…Ù†ØªØ¬";
    var products = ViewBag.Products as List<PesticideShop.Models.Product>;
    var originalInvoiceNumber = ViewBag.OriginalInvoiceNumber as string;
}

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-0">
                                <i class="fas fa-exchange-alt"></i>
                                Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…Ù†ØªØ¬
                            </h2>
                            <p class="mb-0 opacity-75">Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ ÙØ§ØªÙˆØ±Ø© Ø³Ø§Ø¨Ù‚Ø© Ø¨Ù…Ù†ØªØ¬ Ø¢Ø®Ø±</p>
                        </div>
                        <div>
                            <a href="@Url.Action("MultiCreate", new { originalInvoiceNumber = originalInvoiceNumber })" class="btn btn-warning me-2" title="Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…ØªØ¹Ø¯Ø¯ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª">
                                ğŸ”„ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…ØªØ¹Ø¯Ø¯
                            </a>
                            <a href="@Url.Action("Index", "Invoices")" class="btn btn-light">
                                â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙÙˆØ§ØªÙŠØ±
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form asp-action="Create" method="post" id="exchangeForm">
        <div class="row">
            <!-- Exchange Form -->
            <div class="col-md-8">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-edit text-primary"></i>
                            Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Original Invoice -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="OriginalInvoiceNumber" class="form-label">
                                    <i class="fas fa-file-invoice"></i>
                                    Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© *
                                </label>
                                <div class="input-group">
                                    <input asp-for="OriginalInvoiceNumber" class="form-control" 
                                           placeholder="Ù…Ø«Ø§Ù„: INV-20241225-001" 
                                           value="@originalInvoiceNumber" />
                                    <button type="button" id="loadInvoiceBtn" class="btn btn-outline-primary">
                                        ğŸ” ØªØ­Ù…ÙŠÙ„
                                    </button>
                                </div>
                                <span asp-validation-for="OriginalInvoiceNumber" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                    Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ *
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-success text-white">EXC</span>
                                    <input type="text" id="exchangeInvoiceNumber" class="form-control" 
                                           placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø±Ù‚Ù…..." 
                                           maxlength="20" />
                                </div>
                                <small class="form-text text-muted">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹: EXC + Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø°ÙŠ ØªØ¯Ø®Ù„Ù‡</small>
                            </div>
                        </div>
                        
                        <!-- Invoice Status -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div id="invoiceStatus">
                                    <!-- Invoice status will be shown here -->
                                </div>
                            </div>
                        </div>

                        <!-- Original Product Selection -->
                        <div class="row mb-3" id="originalProductSection" style="display: none;">
                            <div class="col-md-6">
                                <label asp-for="OldProductId" class="form-label">
                                    <i class="fas fa-box"></i>
                                    Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ *
                                </label>
                                <select asp-for="OldProductId" class="form-select" id="oldProductSelect">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬...</option>
                                    <!-- Options will be loaded dynamically -->
                                </select>
                                <span asp-validation-for="OldProductId" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="ExchangedQuantity" class="form-label">
                                    <i class="fas fa-sort-numeric-up"></i>
                                    Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ *
                                </label>
                                <input asp-for="ExchangedQuantity" type="number" class="form-control" 
                                       min="1" placeholder="1" />
                                <span asp-validation-for="ExchangedQuantity" class="text-danger"></span>
                                <small class="form-text text-muted" id="availableQuantityText"></small>
                            </div>
                        </div>

                        <!-- New Product Selection -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="NewProductId" class="form-label">
                                    <i class="fas fa-box-open"></i>
                                    Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯ *
                                </label>
                                <select asp-for="NewProductId" class="form-select" id="newProductSelect">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯...</option>
                                    @if (products != null && products.Any())
                                    {
                                        @foreach (var product in products)
                                        {
                                            <option value="@product.Id" 
                                                    data-price="@product.Price" 
                                                    data-quantity="@product.Quantity">
                                                @product.Name - @product.Price.ToString("N2") Ø¬.Ù… (Ù…ØªÙˆÙØ±: @product.Quantity)
                                            </option>
                                        }
                                    }
                                    else
                                    {
                                        <option value="" disabled>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…ØªØ§Ø­Ø©</option>
                                    }
                                </select>
                                <span asp-validation-for="NewProductId" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-calculator"></i>
                                    ÙØ±Ù‚ Ø§Ù„Ø³Ø¹Ø±
                                </label>
                                <div id="priceDifference" class="form-control-plaintext">
                                    <span class="text-muted">Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</span>
                                </div>
                            </div>
                        </div>

                        <!-- Exchange Reason -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label asp-for="ExchangeReason" class="form-label">
                                    <i class="fas fa-comment"></i>
                                    Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
                                </label>
                                <select asp-for="ExchangeReason" class="form-select">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¨Ø¨...</option>
                                    <option value="Ø¹ÙŠØ¨ ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬">Ø¹ÙŠØ¨ ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬</option>
                                    <option value="Ù…Ù‚Ø§Ø³ ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨">Ù…Ù‚Ø§Ø³ ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨</option>
                                    <option value="Ù„ÙˆÙ† ØºÙŠØ± Ù…Ø±ØºÙˆØ¨">Ù„ÙˆÙ† ØºÙŠØ± Ù…Ø±ØºÙˆØ¨</option>
                                    <option value="ØªÙØ¶ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„">ØªÙØ¶ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
                                    <option value="Ù…Ù†ØªØ¬ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©">Ù…Ù†ØªØ¬ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</option>
                                    <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                                </select>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label asp-for="Notes" class="form-label">
                                    <i class="fas fa-sticky-note"></i>
                                    Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
                                </label>
                                <textarea asp-for="Notes" class="form-control" rows="3" 
                                          placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø­ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„..."></textarea>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success" id="submitBtn">
                                        âœ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
                                    </button>
                                    <button type="reset" class="btn btn-outline-secondary">
                                        ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
                                    </button>
                                    <a href="@Url.Action("Index", "Invoices")" class="btn btn-outline-danger">
                                        âŒ Ø¥Ù„ØºØ§Ø¡
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Panel -->
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-clipboard-list"></i>
                            Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="exchangeSummary">
                            <div class="text-center text-muted">
                                <i class="fas fa-info-circle fa-2x mb-3"></i>
                                <p>Ù‚Ù… Ø¨Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ù„Ø®Øµ</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Exchange Rules -->
                <div class="card border-0 shadow-sm mt-3">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-exclamation-triangle"></i>
                            Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="fas fa-check text-success"></i>
                                ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© ÙÙ‚Ø·
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success"></i>
                                Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ØªÙˆÙØ±Ø§Ù‹
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success"></i>
                                ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success"></i>
                                ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ø¯ÙŠØ¯Ø©
                            </li>
                            <li class="mb-0">
                                <i class="fas fa-info text-info"></i>
                                Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„Ø¯ÙØ¹ Ø£Ùˆ Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„ÙØ±Ù‚ ÙÙŠ Ø§Ù„Ø³Ø¹Ø±
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
.bg-gradient-primary {
    background: linear-gradient(45deg, #007bff, #0056b3) !important;
}

.opacity-75 {
    opacity: 0.75;
}

.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
}

.form-label {
    font-weight: 600;
    color: #495057;
}

.form-label i {
    margin-right: 5px;
    color: #6c757d;
}

#priceDifference {
    font-size: 1.1rem;
    font-weight: 600;
    padding: 8px 12px;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background-color: #f8f9fa;
}

.price-positive {
    color: #dc3545 !important;
}

.price-negative {
    color: #28a745 !important;
}

.price-zero {
    color: #6c757d !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const originalInvoiceInput = document.querySelector('[name="OriginalInvoiceNumber"]');
    const loadInvoiceBtn = document.getElementById('loadInvoiceBtn');
    const oldProductSelect = document.getElementById('oldProductSelect');
    const newProductSelect = document.getElementById('newProductSelect');
    const quantityInput = document.querySelector('[name="ExchangedQuantity"]');
    const originalProductSection = document.getElementById('originalProductSection');
    const invoiceStatus = document.getElementById('invoiceStatus');
    const priceDifferenceDiv = document.getElementById('priceDifference');
    const exchangeSummary = document.getElementById('exchangeSummary');
    const exchangeInvoiceNumberInput = document.getElementById('exchangeInvoiceNumber');

    let invoiceItems = [];
    let oldProductPrice = 0;

    // Generate exchange invoice number automatically
    function generateExchangeInvoiceNumber() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const time = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
        
        // Generate a unique number based on timestamp
        const uniqueNumber = `${year}${month}${day}${time}`;
        
        // Set the input value
        exchangeInvoiceNumberInput.value = uniqueNumber;
        
        // Show preview
        showExchangeInvoicePreview();
    }

    // Show exchange invoice number preview
    function showExchangeInvoicePreview() {
        const userInput = exchangeInvoiceNumberInput.value.trim();
        if (userInput) {
            const fullNumber = `EXC${userInput}`;
            const preview = document.getElementById('exchangeInvoicePreview');
            if (preview) {
                preview.textContent = `Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙƒØ§Ù…Ù„: ${fullNumber}`;
            } else {
                // Create preview element if it doesn't exist
                const previewElement = document.createElement('small');
                previewElement.id = 'exchangeInvoicePreview';
                previewElement.className = 'form-text text-success fw-bold';
                previewElement.textContent = `Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙƒØ§Ù…Ù„: ${fullNumber}`;
                exchangeInvoiceNumberInput.parentNode.parentNode.appendChild(previewElement);
            }
        } else {
            const preview = document.getElementById('exchangeInvoicePreview');
            if (preview) {
                preview.remove();
            }
        }
    }

    // Auto-generate exchange invoice number on page load
    generateExchangeInvoiceNumber();

    // Update preview when user types
    exchangeInvoiceNumberInput.addEventListener('input', showExchangeInvoicePreview);

    // Load invoice items
    loadInvoiceBtn.addEventListener('click', async function() {
        const invoiceNumber = originalInvoiceInput.value.trim();
        
        if (!invoiceNumber) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©');
            return;
        }

        try {
            loadInvoiceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            loadInvoiceBtn.disabled = true;

            const response = await fetch(`/Exchange/GetInvoiceItems?invoiceNumber=${encodeURIComponent(invoiceNumber)}`);
            const data = await response.json();

            if (data.success) {
                invoiceItems = data.items;
                populateOldProductSelect();
                originalProductSection.style.display = 'block';
                invoiceStatus.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ (${data.items.length} Ù…Ù†ØªØ¬)
                    </div>
                `;
            } else {
                invoiceStatus.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        ${data.message}
                    </div>
                `;
                originalProductSection.style.display = 'none';
            }
        } catch (error) {
            invoiceStatus.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                </div>
            `;
        } finally {
            loadInvoiceBtn.innerHTML = '<i class="fas fa-search"></i> ØªØ­Ù…ÙŠÙ„';
            loadInvoiceBtn.disabled = false;
        }
    });

    // Populate old product select
    function populateOldProductSelect() {
        oldProductSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬...</option>';
        
        invoiceItems.forEach(item => {
            if (item.canExchange) {
                const option = document.createElement('option');
                option.value = item.productId;
                
                // Build display text with color information
                let displayText = `${item.productName}`;
                if (item.color && item.color.trim() !== '') {
                    displayText += ` - ğŸ¨ ${item.color}`;
                }
                if (item.size && item.size.trim() !== '') {
                    displayText += ` - ğŸ“ ${item.size}`;
                }
                displayText += ` - ${item.unitPrice.toFixed(2)} Ø¬.Ù… (Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.quantity})`;
                
                option.textContent = displayText;
                option.dataset.price = item.unitPrice;
                option.dataset.maxQuantity = item.quantity;
                oldProductSelect.appendChild(option);
            }
        });
    }

    // Update available quantity
    oldProductSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const maxQuantity = selectedOption.dataset.maxQuantity;
            oldProductPrice = parseFloat(selectedOption.dataset.price);
            quantityInput.max = maxQuantity;
            quantityInput.value = Math.min(quantityInput.value || 1, maxQuantity);
            document.getElementById('availableQuantityText').textContent = 
                `Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: ${maxQuantity} Ù‚Ø·Ø¹Ø©`;
            updatePriceDifference();
        } else {
            oldProductPrice = 0;
            document.getElementById('availableQuantityText').textContent = '';
            updatePriceDifference();
        }
    });

    // Update price difference
    newProductSelect.addEventListener('change', updatePriceDifference);
    quantityInput.addEventListener('input', updatePriceDifference);

    function updatePriceDifference() {
        const newProductOption = newProductSelect.options[newProductSelect.selectedIndex];
        const quantity = parseInt(quantityInput.value) || 0;

        if (newProductOption.value && oldProductPrice > 0 && quantity > 0) {
            const newProductPrice = parseFloat(newProductOption.dataset.price);
            const difference = (newProductPrice - oldProductPrice) * quantity;

            let differenceText, differenceClass;
            if (difference > 0) {
                differenceText = `+${difference.toFixed(2)} Ø¬.Ù… (ÙŠØ¬Ø¨ Ø¯ÙØ¹ Ø§Ù„Ù…Ø¨Ù„Øº)`;
                differenceClass = 'price-positive';
            } else if (difference < 0) {
                differenceText = `${difference.toFixed(2)} Ø¬.Ù… (Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù„Ù„Ø¹Ù…ÙŠÙ„)`;
                differenceClass = 'price-negative';
            } else {
                differenceText = '0.00 Ø¬.Ù… (Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±Ù‚)';
                differenceClass = 'price-zero';
            }

            priceDifferenceDiv.innerHTML = `<span class="${differenceClass}">${differenceText}</span>`;
            updateExchangeSummary(difference);
        } else {
            priceDifferenceDiv.innerHTML = '<span class="text-muted">Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</span>';
            updateExchangeSummary(0);
        }
    }

    function updateExchangeSummary(priceDifference) {
        const oldProductOption = oldProductSelect.options[oldProductSelect.selectedIndex];
        const newProductOption = newProductSelect.options[newProductSelect.selectedIndex];
        const quantity = parseInt(quantityInput.value) || 0;

        if (oldProductOption.value && newProductOption.value && quantity > 0) {
            exchangeSummary.innerHTML = `
                <div class="summary-item mb-3">
                    <h6 class="text-primary">Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù‚Ø¯ÙŠÙ…:</h6>
                    <p class="mb-1">${oldProductOption.textContent}</p>
                    <small class="text-muted">Ø§Ù„ÙƒÙ…ÙŠØ©: ${quantity}</small>
                </div>
                <div class="summary-item mb-3">
                    <h6 class="text-success">Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</h6>
                    <p class="mb-1">${newProductOption.textContent}</p>
                    <small class="text-muted">Ø§Ù„ÙƒÙ…ÙŠØ©: ${quantity}</small>
                </div>
                <hr>
                <div class="summary-item">
                    <h6>ÙØ±Ù‚ Ø§Ù„Ø³Ø¹Ø±:</h6>
                    <p class="mb-0 ${priceDifference > 0 ? 'text-danger' : priceDifference < 0 ? 'text-success' : 'text-muted'}">
                        ${priceDifference > 0 ? '+' : ''}${priceDifference.toFixed(2)} Ø¬.Ù…
                    </p>
                    ${priceDifference > 0 ? '<small class="text-danger">ÙŠØ¬Ø¨ Ø¯ÙØ¹ Ø§Ù„ÙØ±Ù‚</small>' : 
                      priceDifference < 0 ? '<small class="text-success">Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù„Ù„Ø¹Ù…ÙŠÙ„</small>' : 
                      '<small class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±Ù‚ ÙÙŠ Ø§Ù„Ø³Ø¹Ø±</small>'}
                </div>
            `;
        } else {
            exchangeSummary.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                    <p>Ù‚Ù… Ø¨Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ù„Ø®Øµ</p>
                </div>
            `;
        }
    }

    // Auto-load if original invoice number is provided
    if (originalInvoiceInput.value) {
        loadInvoiceBtn.click();
    }

    // Handle form submission
    document.getElementById('exchangeForm').addEventListener('submit', function(e) {
        const userInput = exchangeInvoiceNumberInput.value.trim();
        if (!userInput) {
            e.preventDefault();
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„');
            exchangeInvoiceNumberInput.focus();
            return;
        }

        // Create hidden input with full exchange invoice number
        const fullExchangeNumber = `EXC${userInput}`;
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'ExchangeInvoiceNumber';
        hiddenInput.value = fullExchangeNumber;
        this.appendChild(hiddenInput);

        // Show confirmation
        if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${fullExchangeNumber}ØŸ`)) {
            e.preventDefault();
            return;
        }
    });
});
</script>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
