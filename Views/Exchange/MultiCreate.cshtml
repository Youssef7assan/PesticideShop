@model PesticideShop.Models.MultiExchangeRequest
@using PesticideShop.Extensions

@{
    ViewData["Title"] = "Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…ØªØ¹Ø¯Ø¯";
    var products = ViewBag.Products as List<PesticideShop.Models.Product>;
    var originalInvoiceNumber = ViewBag.OriginalInvoiceNumber as string;
}

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-0">
                              
                                Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…ØªØ¹Ø¯Ø¯ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª
                            </h2>
                            <p class="mb-0 opacity-75">Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¹Ø¯Ø© Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† ÙØ§ØªÙˆØ±Ø© Ø³Ø§Ø¨Ù‚Ø© Ø¨Ù…Ù†ØªØ¬Ø§Øª Ø£Ø®Ø±Ù‰</p>
                        </div>
                        <div>
                            <a href="@Url.Action("Create", new { originalInvoiceNumber = originalInvoiceNumber })" class="btn btn-light me-2" title="Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯">
                                â• Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙˆØ§Ø­Ø¯
                            </a>
                            <a href="@Url.Action("Index", "Invoices")" class="btn btn-outline-light">
                                â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙÙˆØ§ØªÙŠØ±
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
           
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <form asp-action="MultiCreate" method="post" id="multiExchangeForm">
        <div class="row">
            <!-- Exchange Form -->
            <div class="col-md-8">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            
                            Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Original Invoice -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="OriginalInvoiceNumber" class="form-label">
                                  
                                    Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© *
                                </label>
                                <div class="input-group">
                                    <input asp-for="OriginalInvoiceNumber" class="form-control" 
                                           placeholder="Ù…Ø«Ø§Ù„: INV-20241225-001" 
                                           value="@originalInvoiceNumber" />
                                    <button type="button" id="loadInvoiceBtn" class="btn btn-outline-primary">
                                        ğŸ” ØªØ­Ù…ÙŠÙ„
                                    </button>
                                </div>
                                <span asp-validation-for="OriginalInvoiceNumber" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                    Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ *
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-success text-white">EXC</span>
                                    <input type="text" id="exchangeInvoiceNumber" class="form-control" 
                                           placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø±Ù‚Ù…..." 
                                           maxlength="20" />
                                    <input type="hidden" asp-for="ExchangeInvoiceNumber" id="exchangeInvoiceNumberHidden" />
                                </div>
                                <small class="form-text text-muted">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹: EXC + Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø°ÙŠ ØªØ¯Ø®Ù„Ù‡</small>
                            </div>
                        </div>
                        
                        <!-- Invoice Status -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div id="invoiceStatus">
                                    <!-- Invoice status will be shown here -->
                                </div>
                            </div>
                        </div>

                        <!-- Exchange Items Section -->
                        <div class="card mt-4" id="exchangeItemsSection" style="display: none;">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                   
                                    Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
                                    <button type="button" class="btn btn-success btn-sm float-end" id="addExchangeItem">
                                        
                                        Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬
                                    </button>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="exchangeItemsContainer">
                                    <!-- Exchange items will be added here dynamically -->
                                </div>
                                <div id="noItemsMessage" class="text-center text-muted py-4">
                                  
                                    <p>Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨Ø¹Ø¯</p>
                                    <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„</p>
                                </div>
                            </div>
                        </div>

                        <!-- Summary Section -->
                        <div class="card mt-4" id="summaryCard" style="display: none;">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    
                                    Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <h6 class="text-muted">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h6>
                                            <h4 id="totalItems">0</h4>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <h6 class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</h6>
                                            <h4 id="totalQuantity">0</h4>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <h6 class="text-muted">Ø§Ù„ÙØ±Ù‚ ÙÙŠ Ø§Ù„Ø³Ø¹Ø±</h6>
                                            <h4 id="totalPriceDifference" class="text-success">0.00 Ø¬.Ù…</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Exchange Reason -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label asp-for="ExchangeReason" class="form-label">
                                   
                                    Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
                                </label>
                                <select asp-for="ExchangeReason" class="form-select">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¨Ø¨...</option>
                                    <option value="Ø¹ÙŠØ¨ ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬">Ø¹ÙŠØ¨ ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬</option>
                                    <option value="Ù…Ù‚Ø§Ø³ ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨">Ù…Ù‚Ø§Ø³ ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨</option>
                                    <option value="Ù„ÙˆÙ† ØºÙŠØ± Ù…Ø±ØºÙˆØ¨">Ù„ÙˆÙ† ØºÙŠØ± Ù…Ø±ØºÙˆØ¨</option>
                                    <option value="ØªÙØ¶ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„">ØªÙØ¶ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
                                    <option value="Ù…Ù†ØªØ¬ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©">Ù…Ù†ØªØ¬ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</option>
                                    <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                                </select>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label asp-for="Notes" class="form-label">
                                    
                                    Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
                                </label>
                                <textarea asp-for="Notes" class="form-control" rows="3" 
                                          placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø­ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„..."></textarea>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success" id="submitBtn" disabled>
                                        âœ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
                                    </button>
                                    <button type="reset" class="btn btn-outline-secondary">
                                        ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
                                    </button>
                                    <a href="@Url.Action("Index", "Invoices")" class="btn btn-outline-danger">
                                        âŒ Ø¥Ù„ØºØ§Ø¡
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Panel -->
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                          
                            Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="exchangeSummary">
                            <div class="text-center text-muted">
                              
                                <p>Ù‚Ù… Ø¨Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ù„Ø®Øµ</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Exchange Rules -->
                <div class="card border-0 shadow-sm mt-3">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                           
                            Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                              
                                ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¹Ø¯Ø© Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø©
                            </li>
                            <li class="mb-2">
                              
                                Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…ØªÙˆÙØ±Ø©
                            </li>
                            <li class="mb-2">
                              
                                Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±ÙˆÙ‚ ÙÙŠ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                            </li>
                            <li class="mb-2">
                              
                                ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø­Ø°Ù Ù…Ù†ØªØ¬Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                            </li>
                            <li class="mb-0">
                              
                                Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙˆØ§Ø­Ø¯Ø©
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Exchange Item Template -->
<template id="exchangeItemTemplate">
    <div class="exchange-item card mb-3" data-item-index="">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
               
                Ù…Ù†ØªØ¬ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ <span class="item-number">1</span>
            </h6>
            <button type="button" class="btn btn-danger btn-sm remove-item">
               
                Ø­Ø°Ù
            </button>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group mb-3">
                        <label class="form-label">Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù‚Ø¯ÙŠÙ…</label>
                        <select class="form-select old-product-select" name="ExchangeItems[INDEX].OldProductId" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù‚Ø¯ÙŠÙ…</option>
                            <!-- Options will be loaded from invoice items -->
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group mb-3">
                        <label class="form-label">Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                        <select class="form-select new-product-select" name="ExchangeItems[INDEX].NewProductId" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯</option>
                            @foreach (var product in ViewBag.Products as List<PesticideShop.Models.Product>)
                            {
                                var productDisplayText = $"{product.Name} - {product.Price} Ø¬.Ù… (Ù…ØªÙˆÙØ±: {product.Quantity})";
                                if (!string.IsNullOrEmpty(product.Color))
                                {
                                    productDisplayText += $" - Ø§Ù„Ù„ÙˆÙ†: {product.Color}";
                                }
                                if (product.Size != 0)
                                {
                                    productDisplayText += $" - Ø§Ù„Ù…Ù‚Ø§Ø³: {product.Size.GetDisplayName()}";
                                }
                                <option value="@product.Id" 
                                        data-price="@product.Price" 
                                        data-quantity="@product.Quantity"
                                        data-color="@(product.Color ?? "")"
                                        data-size="@product.Size.GetDisplayName()">
                                    @productDisplayText
                                </option>
                            }
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group mb-3">
                        <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                        <input type="number" class="form-control quantity-input" name="ExchangeItems[INDEX].ExchangedQuantity" min="1" max="999" required>
                        <small class="form-text text-muted quantity-help">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</small>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group mb-3">
                        <label class="form-label">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…</label>
                        <input type="text" class="form-control old-price-display" readonly>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group mb-3">
                        <label class="form-label">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                        <input type="text" class="form-control new-price-display" readonly>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="alert alert-info mb-0">
                        <strong>Ø§Ù„ÙØ±Ù‚ ÙÙŠ Ø§Ù„Ø³Ø¹Ø±:</strong> <span class="price-difference">0.00 Ø¬.Ù…</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-warning mb-0">
                        <strong>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</strong> <span class="product-names">-</span>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="alert alert-info mb-0">
                        <strong>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù‚Ø¯ÙŠÙ…:</strong> <span class="old-product-details">-</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-success mb-0">
                        <strong>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</strong> <span class="new-product-details">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

@section Scripts {
    <script>
        $(document).ready(function() {
          
            let itemIndex = 0;
            let invoiceItems = [];

            // Load invoice items when invoice number is entered
            $('#loadInvoiceBtn').click(function() {
                loadInvoiceItems();
            });

            // Auto-load if invoice number is already provided
            @if (!string.IsNullOrEmpty(Model.OriginalInvoiceNumber))
            {
                <text>
                loadInvoiceItems();
                </text>
            }

            // Update exchange invoice number automatically
            $('#exchangeInvoiceNumber').on('input', function() {
                const userInput = $(this).val();
                const fullNumber = 'EXC' + userInput;
                $('#exchangeInvoiceNumberHidden').val(fullNumber);
            });

            // Initialize exchange invoice number if empty
            if (!$('#exchangeInvoiceNumberHidden').val()) {
                const currentDate = new Date();
                const dateString = currentDate.getFullYear().toString() + 
                                 (currentDate.getMonth() + 1).toString().padStart(2, '0') + 
                                 currentDate.getDate().toString().padStart(2, '0');
                const timeString = currentDate.getHours().toString().padStart(2, '0') + 
                                 currentDate.getMinutes().toString().padStart(2, '0') + 
                                 currentDate.getSeconds().toString().padStart(2, '0');
                const autoNumber = dateString + timeString;
                $('#exchangeInvoiceNumber').val(autoNumber);
                $('#exchangeInvoiceNumberHidden').val('EXC' + autoNumber);
            } else {
                // If there's already a value, extract the part after EXC
                const existingValue = $('#exchangeInvoiceNumberHidden').val();
                if (existingValue && existingValue.startsWith('EXC')) {
                    $('#exchangeInvoiceNumber').val(existingValue.substring(3));
                }
            }

            // Add new exchange item
            $('#addExchangeItem').click(function(e) {
                e.preventDefault();
               
                addExchangeItem();
            });

            // Remove exchange item
            $(document).on('click', '.remove-item', function() {
               
                $(this).closest('.exchange-item').remove();
                updateItemNumbers();
                updateSummary();
                updateSubmitButton();
            });

            // Update prices and calculations when products or quantity change
            $(document).on('change', '.old-product-select, .new-product-select, .quantity-input', function() {
               
                updateItemCalculations($(this).closest('.exchange-item'));
                updateSummary();
                updateSubmitButton();
            });

            // Update quantity max when old product is selected
            $(document).on('change', '.old-product-select', function() {
                const $select = $(this);
                const $item = $select.closest('.exchange-item');
                const $quantityInput = $item.find('.quantity-input');
                const $quantityHelp = $item.find('.quantity-help');
                const selectedOption = $select.find('option:selected');
                
                if (selectedOption.length && selectedOption.val()) {
                    const maxQuantity = parseInt(selectedOption.data('quantity')) || 0;
                    $quantityInput.attr('max', maxQuantity);
                    $quantityHelp.text(`Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: ${maxQuantity}`);
                    
                    // Clear current quantity if it exceeds the new max
                    const currentQuantity = parseInt($quantityInput.val()) || 0;
                    if (currentQuantity > maxQuantity) {
                        $quantityInput.val('');
                    }
                } else {
                    $quantityInput.attr('max', 999);
                    $quantityHelp.text('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹');
                }
            });

            // Validate quantity input
            $(document).on('input change', '.quantity-input', function() {
                const $input = $(this);
                const $item = $input.closest('.exchange-item');
                const $oldProductSelect = $item.find('.old-product-select');
                const $quantityHelp = $item.find('.quantity-help');
                const selectedOption = $oldProductSelect.find('option:selected');
                
                if (selectedOption.length && selectedOption.val()) {
                    const maxQuantity = parseInt(selectedOption.data('quantity')) || 0;
                    const enteredQuantity = parseInt($input.val()) || 0;
                    
                    // Remove previous validation classes
                    $input.removeClass('is-valid is-invalid');
                    $quantityHelp.removeClass('text-success text-danger');
                    
                    if (enteredQuantity > maxQuantity) {
                        $input.val(maxQuantity);
                        $input.addClass('is-invalid');
                        $quantityHelp.addClass('text-danger').text(`Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: ${maxQuantity} (ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)`);
                        alert(`Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© (${enteredQuantity}) ØªØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø© (${maxQuantity}). ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.`);
                        updateItemCalculations($item);
                        updateSummary();
                        updateSubmitButton();
                    } else if (enteredQuantity > 0 && enteredQuantity <= maxQuantity) {
                        $input.addClass('is-valid');
                        $quantityHelp.addClass('text-success').text(`Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: ${maxQuantity} âœ“`);
                    } else if (enteredQuantity === 0) {
                        $quantityHelp.removeClass('text-success text-danger').text(`Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: ${maxQuantity}`);
                    }
                }
            });

            function loadInvoiceItems() {
                const invoiceNumber = $('#OriginalInvoiceNumber').val();
                if (!invoiceNumber) {
                    alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹');
                    return;
                }

                $('#loadInvoiceBtn').prop('disabled', true).html('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...');

                $.get('@Url.Action("GetInvoiceItems", "Exchange")', { invoiceNumber: invoiceNumber })
                    .done(function(response) {
                       
                        if (response.success) {
                            invoiceItems = response.items;
                        
                            displayInvoiceStatus(response.items);
                            $('#exchangeItemsSection').show();
                            updateExchangeSummary();
                        } else {
                            alert('Ø®Ø·Ø£: ' + response.message);
                        }
                    })
                    .fail(function(xhr, status, error) {
                     
                        alert('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + error);
                    })
                    .always(function() {
                        $('#loadInvoiceBtn').prop('disabled', false).html('ğŸ” ØªØ­Ù…ÙŠÙ„');
                    });
            }

            function displayInvoiceStatus(items) {
                const exchangeableItems = items.filter(item => item.canExchange);
                const statusHtml = `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-file-invoice"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h6>
                        <p class="mb-1"><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</strong> ${items.length}</p>
                        <p class="mb-1"><strong>Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„:</strong> ${exchangeableItems.length}</p>
                        <p class="mb-0"><strong>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„:</strong></p>
                        <ul class="mb-0 mt-2">
                            ${exchangeableItems.length > 0 ? 
                                exchangeableItems.map(item => 
                                    `<li><strong>${item.productName}</strong> - Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.quantity} - Ø§Ù„Ø³Ø¹Ø±: ${item.unitPrice} Ø¬.Ù…</li>`
                                ).join('') : 
                                '<li class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„</li>'
                            }
                        </ul>
                    </div>
                `;
                $('#invoiceStatus').html(statusHtml);
            }

            function addExchangeItem() {
                console.log('addExchangeItem called, invoiceItems length:', invoiceItems.length); // Debug log
                
                if (invoiceItems.length === 0) {
                    alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹');
                    return;
                }

                const template = document.getElementById('exchangeItemTemplate');
                if (!template) {
                    console.error('Template not found!'); // Debug log
                    alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨');
                    return;
                }

                const clone = template.content.cloneNode(true);
                
                // Update index placeholders
                const html = clone.querySelector('.exchange-item').outerHTML;
                const updatedHtml = html.replace(/INDEX/g, itemIndex);
                
                $('#exchangeItemsContainer').append(updatedHtml);
                $('#noItemsMessage').hide();
                $('#summaryCard').show();
                
               
                
                // Populate old product options with invoice items
                const $newItem = $('#exchangeItemsContainer .exchange-item').last();
                const $oldProductSelect = $newItem.find('.old-product-select');
                
                // Clear existing options except the first one
                $oldProductSelect.find('option:not(:first)').remove();
               
                
                // Add invoice items as options
                const exchangeableItems = invoiceItems.filter(item => item.canExchange);
               
                
                if (exchangeableItems.length === 0) {
                    $oldProductSelect.append('<option value="" disabled>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„</option>');
                } else {
                    exchangeableItems.forEach(item => {
                        const optionText = `${item.productName} - ${item.unitPrice} Ø¬.Ù… (Ù…ØªÙˆÙØ±: ${item.quantity})${item.color ? ` - Ø§Ù„Ù„ÙˆÙ†: ${item.color}` : ''}${item.size ? ` - Ø§Ù„Ù…Ù‚Ø§Ø³: ${item.size}` : ''}`;
                        $oldProductSelect.append(`
                            <option value="${item.productId}" 
                                    data-price="${item.unitPrice}" 
                                    data-quantity="${item.quantity}"
                                    data-color="${item.color || ''}"
                                    data-size="${item.size || ''}">
                                ${optionText}
                            </option>
                        `);
                    });
                }
                
                itemIndex++;
               
                
                updateItemNumbers();
                updateSummary();
                updateSubmitButton();
                
             
            }

            function updateItemNumbers() {
                $('.exchange-item').each(function(index) {
                    $(this).find('.item-number').text(index + 1);
                    $(this).attr('data-item-index', index);
                    
                    // Update form field names
                    $(this).find('select, input').each(function() {
                        const name = $(this).attr('name');
                        if (name) {
                            $(this).attr('name', name.replace(/\[\d+\]/, '[' + index + ']'));
                        }
                    });
                });
            }

            function updateItemCalculations(item) {
                const oldProductSelect = item.find('.old-product-select');
                const newProductSelect = item.find('.new-product-select');
                const quantityInput = item.find('.quantity-input');
                
                const oldPrice = parseFloat(oldProductSelect.find('option:selected').data('price')) || 0;
                const newPrice = parseFloat(newProductSelect.find('option:selected').data('price')) || 0;
                const quantity = parseInt(quantityInput.val()) || 0;
                
                const priceDifference = (newPrice - oldPrice) * quantity;
                
                item.find('.old-price-display').val(oldPrice.toFixed(2) + ' Ø¬.Ù…');
                item.find('.new-price-display').val(newPrice.toFixed(2) + ' Ø¬.Ù…');
                item.find('.price-difference').text(priceDifference.toFixed(2) + ' Ø¬.Ù…');
                
                const oldProductName = oldProductSelect.find('option:selected').text();
                const newProductName = newProductSelect.find('option:selected').text();
                item.find('.product-names').text(`${oldProductName} â†’ ${newProductName}`);
                
                // Update product details
                const oldSelectedOption = oldProductSelect.find('option:selected');
                const newSelectedOption = newProductSelect.find('option:selected');
                
                let oldDetails = '-';
                let newDetails = '-';
                
                if (oldSelectedOption.length && oldSelectedOption.val()) {
                    const oldColor = oldSelectedOption.data('color') || '';
                    const oldSize = oldSelectedOption.data('size') || '';
                    oldDetails = `Ø§Ù„Ø³Ø¹Ø±: ${oldPrice.toFixed(2)} Ø¬.Ù…`;
                    if (oldColor) oldDetails += ` | Ø§Ù„Ù„ÙˆÙ†: ${oldColor}`;
                    if (oldSize) oldDetails += ` | Ø§Ù„Ù…Ù‚Ø§Ø³: ${oldSize}`;
                }
                
                if (newSelectedOption.length && newSelectedOption.val()) {
                    const newColor = newSelectedOption.data('color') || '';
                    const newSize = newSelectedOption.data('size') || '';
                    const newQuantity = newSelectedOption.data('quantity') || 0;
                    newDetails = `Ø§Ù„Ø³Ø¹Ø±: ${newPrice.toFixed(2)} Ø¬.Ù… | Ù…ØªÙˆÙØ±: ${newQuantity}`;
                    if (newColor) newDetails += ` | Ø§Ù„Ù„ÙˆÙ†: ${newColor}`;
                    if (newSize) newDetails += ` | Ø§Ù„Ù…Ù‚Ø§Ø³: ${newSize}`;
                }
                
                item.find('.old-product-details').text(oldDetails);
                item.find('.new-product-details').text(newDetails);
                
                // Color coding for price difference
                const priceDiffElement = item.find('.price-difference');
                if (priceDifference > 0) {
                    priceDiffElement.removeClass('text-success text-danger').addClass('text-danger');
                } else if (priceDifference < 0) {
                    priceDiffElement.removeClass('text-success text-danger').addClass('text-success');
                } else {
                    priceDiffElement.removeClass('text-success text-danger');
                }
            }

            function updateSummary() {
                const items = $('.exchange-item');
                const totalItems = items.length;
                let totalQuantity = 0;
                let totalPriceDifference = 0;
                
                console.log('updateSummary called, total items:', totalItems); // Debug log
                
                items.each(function() {
                    const quantity = parseInt($(this).find('.quantity-input').val()) || 0;
                    const priceDiffText = $(this).find('.price-difference').text();
                    const priceDiff = parseFloat(priceDiffText.replace(' Ø¬.Ù…', '')) || 0;
                    
                    totalQuantity += quantity;
                    totalPriceDifference += priceDiff;
                });
                
                console.log('Summary calculated - Items:', totalItems, 'Quantity:', totalQuantity, 'Price Diff:', totalPriceDifference); // Debug log
                
                $('#totalItems').text(totalItems);
                $('#totalQuantity').text(totalQuantity);
                $('#totalPriceDifference').text(totalPriceDifference.toFixed(2) + ' Ø¬.Ù…');
                
                // Update sidebar summary
                $('#summaryTotalItems').text(totalItems);
                $('#summaryTotalQuantity').text(totalQuantity);
                $('#summaryTotalPrice').text(totalPriceDifference.toFixed(2) + ' Ø¬.Ù…');
                
                // Color coding for total price difference
                const totalPriceElement = $('#totalPriceDifference');
                const summaryPriceElement = $('#summaryTotalPrice');
                if (totalPriceDifference > 0) {
                    totalPriceElement.removeClass('text-success text-danger').addClass('text-danger');
                    summaryPriceElement.removeClass('text-success text-danger').addClass('text-danger');
                } else if (totalPriceDifference < 0) {
                    totalPriceElement.removeClass('text-success text-danger').addClass('text-success');
                    summaryPriceElement.removeClass('text-success text-danger').addClass('text-success');
                } else {
                    totalPriceElement.removeClass('text-success text-danger');
                    summaryPriceElement.removeClass('text-success text-danger');
                }
            }

            function updateExchangeSummary() {
                if (invoiceItems.length === 0) {
                    $('#exchangeSummary').html(`
                        <div class="text-center text-muted">
                            <i class="fas fa-info-circle fa-2x mb-3"></i>
                            <p>Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹</p>
                        </div>
                    `);
                    return;
                }

                const exchangeableItems = invoiceItems.filter(item => item.canExchange);
                const summaryHtml = `
                    <div class="mb-3">
                        <h6><i class="fas fa-file-invoice"></i> Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</h6>
                        <p class="mb-1"><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${$('#OriginalInvoiceNumber').val()}</p>
                        <p class="mb-1"><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</strong> ${invoiceItems.length}</p>
                        <p class="mb-0"><strong>Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„:</strong> ${exchangeableItems.length}</p>
                    </div>
                    <div class="mb-3">
                        <h6><i class="fas fa-exchange-alt"></i> Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯</h6>
                        <p class="mb-1"><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©:</strong> <span id="summaryTotalItems">0</span></p>
                        <p class="mb-1"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©:</strong> <span id="summaryTotalQuantity">0</span></p>
                        <p class="mb-0"><strong>Ø§Ù„ÙØ±Ù‚ ÙÙŠ Ø§Ù„Ø³Ø¹Ø±:</strong> <span id="summaryTotalPrice">0.00 Ø¬.Ù…</span></p>
                    </div>
                `;
                $('#exchangeSummary').html(summaryHtml);
            }

            function updateSubmitButton() {
                const hasItems = $('.exchange-item').length > 0;
                const allValid = $('.exchange-item').length > 0 && 
                    $('.exchange-item').toArray().every(item => {
                        const $item = $(item);
                        return $item.find('.old-product-select').val() && 
                               $item.find('.new-product-select').val() && 
                               $item.find('.quantity-input').val();
                    });
                
                console.log('updateSubmitButton - hasItems:', hasItems, 'allValid:', allValid); // Debug log
                
                $('#submitBtn').prop('disabled', !allValid);
                
                if (allValid) {
                    console.log('Submit button enabled'); // Debug log
                } else {
                    console.log('Submit button disabled'); // Debug log
                }
            }

            // Form submission
            $('#multiExchangeForm').on('submit', function(e) {
                const items = $('.exchange-item');
                if (items.length === 0) {
                    e.preventDefault();
                    alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„');
                    return false;
                }
                
                // Validate all items have required fields and quantities
                let isValid = true;
                let validationMessage = '';
                
                items.each(function() {
                    const $item = $(this);
                    const oldProduct = $item.find('.old-product-select').val();
                    const newProduct = $item.find('.new-product-select').val();
                    const quantity = parseInt($item.find('.quantity-input').val()) || 0;
                    const selectedOption = $item.find('.old-product-select option:selected');
                    const maxQuantity = parseInt(selectedOption.data('quantity')) || 0;
                    
                    if (!oldProduct || !newProduct || !quantity) {
                        isValid = false;
                        validationMessage = 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©';
                        return false;
                    }
                    
                    if (quantity <= 0) {
                        isValid = false;
                        validationMessage = 'Ø§Ù„ÙƒÙ…ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±';
                        return false;
                    }
                    
                    if (quantity > maxQuantity) {
                        isValid = false;
                        validationMessage = `Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© (${quantity}) ØªØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø© (${maxQuantity})`;
                        return false;
                    }
                });
                
                if (!isValid) {
                    e.preventDefault();
                    alert(validationMessage);
                    return false;
                }
                
                const confirmMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ Ù„Ù€ ${items.length} Ù…Ù†ØªØ¬ØŸ`;
                if (!confirm(confirmMessage)) {
                    e.preventDefault();
                    return false;
                }
            });

            // Initialize with one item if original invoice number is provided
            @if (!string.IsNullOrEmpty(Model.OriginalInvoiceNumber))
            {
                <text>
                addExchangeItem();
                </text>
            }
        });
    </script>

    <style>
        .bg-gradient-primary {
            background: linear-gradient(45deg, #007bff, #0056b3) !important;
        }

        .opacity-75 {
            opacity: 0.75;
        }

        .exchange-item {
            transition: all 0.2s ease;
        }

        .exchange-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,.1);
        }

        .card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,.15) !important;
        }

        .btn-group-vertical .btn {
            border-radius: 0.25rem !important;
            margin-bottom: 2px;
        }

        .badge {
            font-size: 0.75em;
        }

        .fw-bold {
            font-weight: 600 !important;
        }

        .form-control:focus, .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .alert {
            border: none;
            border-radius: 0.5rem;
        }

        .text-danger {
            color: #dc3545 !important;
        }

        .text-success {
            color: #28a745 !important;
        }

        /* Enhanced product details styling */
        .old-product-details, .new-product-details {
            font-size: 0.9em;
            line-height: 1.4;
        }

        .alert-info .old-product-details {
            color: #0c5460;
        }

        .alert-success .new-product-details {
            color: #155724;
        }

        /* Product select styling */
        .form-select option {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
        }

        .form-select option:hover {
            background-color: #f8f9fa;
        }

        /* Enhanced product display */
        .product-display-text {
            font-weight: 500;
            color: #495057;
        }

        .product-price {
            color: #28a745;
            font-weight: 600;
        }

        .product-quantity {
            color: #6c757d;
            font-size: 0.9em;
        }

        .product-color {
            color: #007bff;
            font-weight: 500;
        }

        .product-size {
            color: #fd7e14;
            font-weight: 500;
        }
    </style>
}
