@model PesticideShop.Models.Customer

@{
    ViewData["Title"] = "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„";
    var remainingBalance = ViewData["RemainingBalance"] as decimal? ?? 0;
    var invoices = ViewData["Invoices"] as List<PesticideShop.Models.Invoice>;
    
    // Ø­Ø³Ø§Ø¨ Ø¯Ù‚ÙŠÙ‚ Ù„Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ ÙˆØ§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
    var transactions = Model.Transactions ?? new List<PesticideShop.Models.CustomerTransaction>();
    
    var totalPurchases = transactions.Sum(t => t.TotalPrice);
    var totalPaid = transactions.Sum(t => t.AmountPaid);
    var actualBalance = totalPurchases - totalPaid;
    
    // ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
    var positiveTransactions = transactions.Where(t => t.TotalPrice > 0).ToList(); // Ù…Ø´ØªØ±ÙŠØ§Øª
    var negativeTransactions = transactions.Where(t => t.TotalPrice < 0).ToList(); // Ø¥Ø±Ø¬Ø§Ø¹/Ø§Ø³ØªØ¨Ø¯Ø§Ù„
    var zeroTransactions = transactions.Where(t => t.TotalPrice == 0).ToList(); // Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø£Ø®Ø±Ù‰
    
    var totalSales = positiveTransactions.Sum(t => t.TotalPrice);
    var totalReturns = Math.Abs(negativeTransactions.Sum(t => t.TotalPrice));
    var netPurchases = totalSales - totalReturns;
    
    var totalPaidForSales = positiveTransactions.Sum(t => t.AmountPaid);
    var totalPaidForReturns = negativeTransactions.Sum(t => t.AmountPaid);
    
    // Ø§ÙƒØªØ´Ø§Ù Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¯ÙØ¹ (ÙÙ‚Ø· Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠØŒ ÙˆÙ„ÙŠØ³ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„)
    var incorrectPayments = negativeTransactions.Where(t => t.AmountPaid > 0 && t.Notes?.Contains("Ø§Ø³ØªØ¨Ø¯Ø§Ù„") != true).ToList();
    var totalIncorrectAmount = incorrectPayments.Sum(t => t.AmountPaid + Math.Abs(t.TotalPrice));
    
    // Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
    var exchangeTransactions = negativeTransactions.Where(t => t.Notes?.Contains("Ø§Ø³ØªØ¨Ø¯Ø§Ù„") == true).ToList();
    var exchangePayments = exchangeTransactions.Where(t => t.AmountPaid > 0).ToList();
    var totalExchangeAmount = exchangePayments.Sum(t => t.AmountPaid);
    
    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©
    var totalDiscount = transactions.Sum(t => t.Discount);
    var averageTransactionValue = transactions.Any() ? transactions.Average(t => t.TotalPrice) : 0;
    var mostFrequentProduct = transactions.GroupBy(t => t.Product?.Name)
                                         .OrderByDescending(g => g.Count())
                                         .FirstOrDefault();
    var lastVisit = transactions.OrderByDescending(t => t.Date).FirstOrDefault()?.Date;
    var firstVisit = transactions.OrderBy(t => t.Date).FirstOrDefault()?.Date;
    var customerLifetime = lastVisit.HasValue && firstVisit.HasValue ? (lastVisit.Value - firstVisit.Value).Days : 0;
    
    // Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø¥Ù„Ù‰ Ù†Øµ Ø¹Ø±Ø¨ÙŠ
    string GetPaymentMethodDisplayName(string paymentMethod)
    {
        return paymentMethod switch
        {
            "cash" => "ğŸ’µ Ù†Ù‚Ø¯Ø§Ù‹",
            "visa" => "ğŸ’³ ÙÙŠØ²Ø§",
            "instapay" => "ğŸ“± Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ",
            "wallet" => "ğŸ‘› Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©",
            "delivery" => "ğŸšš Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…",
            _ => paymentMethod
        };
    }
}

<style>
    .sortable {
        cursor: pointer;
        user-select: none;
    }
    
    .sortable:hover {
        background-color: #f8f9fa;
    }
    
    .sortable::after {
        content: 'â†•ï¸';
        margin-right: 5px;
        opacity: 0.5;
    }
    
    .sortable.sort-asc::after {
        content: 'â†‘';
        opacity: 1;
    }
    
    .sortable.sort-desc::after {
        content: 'â†“';
        opacity: 1;
    }
    
    .filter-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .transaction-type-filter {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .filter-btn {
        padding: 5px 15px;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .filter-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .stats-card {
        transition: transform 0.3s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
    }
    
    .quick-action-card {
        transition: all 0.3s ease;
        border: 1px solid #dee2e6;
    }
    
    .quick-action-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .export-options {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        display: none;
        min-width: 150px;
    }
    
    .export-options.show {
        display: block;
    }
    
    .export-options a {
        display: block;
        padding: 8px 15px;
        text-decoration: none;
        color: #333;
        border-bottom: 1px solid #eee;
    }
    
    .export-options a:last-child {
        border-bottom: none;
    }
    
    .export-options a:hover {
        background: #f8f9fa;
    }
    
    .table-container {
        overflow-x: auto;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .table th {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    .badge {
        font-size: 0.75em;
    }
    
    .btn-group-vertical .btn {
        margin-bottom: 2px;
    }
    
    .btn-group-vertical .btn:last-child {
        margin-bottom: 0;
    }
</style>

<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="mb-2">ğŸ‘¥ Ø¯ÙØªØ± Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„</h1>
                            <p class="mb-0">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø¹ ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <a asp-action="AddTransaction" asp-route-id="@Model.Id" class="btn btn-success me-2">
                                ğŸ’° Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø©
                            </a>
                            <a asp-action="Index" class="btn btn-outline-light">
                                â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Information & Account Summary -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
                            <p class="fw-bold customer-name">@Model.Name</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
                            <p class="fw-bold font-monospace customer-phone">@Model.PhoneNumbers</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                            <p class="fw-bold customer-email">@(string.IsNullOrEmpty(Model.Email) ? "ØºÙŠØ± Ù…Ø­Ø¯Ø¯" : Model.Email)</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„:</label>
                            <p class="fw-bold customer-address">@Model.FullAddress</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª:</label>
                            <p class="fw-bold">@(Model.Transactions?.Count ?? 0) Ù…Ø¹Ø§Ù…Ù„Ø©</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨:</label>
                            <p class="fw-bold @(actualBalance > 0 ? "text-danger" : "text-success")">
                                @(actualBalance > 0 ? "Ù…Ø¯ÙŠÙ†" : "Ù…ÙØ³Ø¯Ø¯")
                            </p>
                        </div>
                    </div>
                    @if (lastVisit.HasValue)
                    {
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©:</label>
                                <p class="fw-bold">@lastVisit.Value.ToString("dd/MM/yyyy")</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ø¹Ù…Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
                                <p class="fw-bold">@customerLifetime ÙŠÙˆÙ…</p>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ’° Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨</h5>
                </div>
                <div class="card-body">
                    @if (invoices?.Any() == true)
                    {
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Ù…ØµØ¯Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª:</label>
                                <div>
                                    @{
                                        var orderOrigins = invoices.Select(i => i.OrderOrigin).Distinct().ToList();
                                        var originCounts = orderOrigins.ToDictionary(o => o, o => invoices.Count(i => i.OrderOrigin == o));
                                    }
                                    @foreach (var origin in originCounts)
                                    {
                                        var icon = origin.Key switch
                                        {
                                            PesticideShop.Models.OrderOrigin.Website => "ğŸŒ",
                                            PesticideShop.Models.OrderOrigin.Instagram => "ğŸ“·",
                                            PesticideShop.Models.OrderOrigin.Facebook => "ğŸ“˜",
                                            PesticideShop.Models.OrderOrigin.WhatsApp => "ğŸ’¬",
                                            PesticideShop.Models.OrderOrigin.Phone => "ğŸ“",
                                            PesticideShop.Models.OrderOrigin.WalkIn => "ğŸš¶",
                                            _ => "â“"
                                        };
                                        <span class="badge bg-secondary me-1">@icon @origin.Value</span>
                                    }
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ğŸ’³ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©:</label>
                                <div>
                                    @{
                                        var paymentMethods = invoices.Where(i => !string.IsNullOrEmpty(i.PaymentMethod))
                                                                   .Select(i => i.PaymentMethod)
                                                                   .Distinct()
                                                                   .ToList();
                                    }
                                    @if (paymentMethods.Any())
                                    {
                                        @foreach (var method in paymentMethods.Take(3))
                                        {
                                            <span class="badge bg-info me-1">@GetPaymentMethodDisplayName(method)</span>
                                        }
                                        @if (paymentMethods.Count > 3)
                                        {
                                            <span class="badge bg-light text-dark">+@(paymentMethods.Count - 3) Ø£ÙƒØ«Ø±</span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                    
                    @if (incorrectPayments.Any())
                    {
                        <div class="alert alert-danger mt-3">
                            <h6>âš ï¸ ØªØ­Ø°ÙŠØ±: Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¯ÙØ¹!</h6>
                            <p class="mb-1">ÙŠÙˆØ¬Ø¯ @incorrectPayments.Count Ù…Ø¹Ø§Ù…Ù„Ø© Ø¥Ø±Ø¬Ø§Ø¹ ØªÙ… Ø§Ù„Ø¯ÙØ¹ ÙÙŠÙ‡Ø§ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯.</p>
                            <p class="mb-0"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ø·Ø£:</strong> @totalIncorrectAmount.ToString("N2") Ø¬Ù†ÙŠÙ‡</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2 text-center mb-3">
                            <div class="border rounded p-3 stats-card">
                                <div class="fs-1 mb-2">ğŸ›’</div>
                                <h4 data-total-sales="@totalSales.ToString("N2")">@positiveTransactions.Count</h4>
                                <small class="text-muted">Ù…Ø¹Ø§Ù…Ù„Ø© Ø´Ø±Ø§Ø¡</small>
                            </div>
                        </div>
                        <div class="col-md-2 text-center mb-3">
                            <div class="border rounded p-3 stats-card">
                                <div class="fs-1 mb-2">â†©ï¸</div>
                                <h4 data-total-returns="@totalReturns.ToString("N2")">@negativeTransactions.Count</h4>
                                <small class="text-muted">Ù…Ø¹Ø§Ù…Ù„Ø© Ø¥Ø±Ø¬Ø§Ø¹</small>
                            </div>
                        </div>
                        <div class="col-md-2 text-center mb-3">
                            <div class="border rounded p-3 stats-card">
                                <div class="fs-1 mb-2">ğŸ“¦</div>
                                <h4>@(positiveTransactions.Sum(t => Math.Abs(t.Quantity)))</h4>
                                <small class="text-muted">Ù‚Ø·Ø¹Ø© Ù…Ø´ØªØ±Ø§Ø©</small>
                            </div>
                        </div>
                        <div class="col-md-2 text-center mb-3">
                            <div class="border rounded p-3 stats-card">
                                <div class="fs-1 mb-2">ğŸ’°</div>
                                <h4>@averageTransactionValue.ToString("N0")</h4>
                                <small class="text-muted">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</small>
                            </div>
                        </div>
                        <div class="col-md-2 text-center mb-3">
                            <div class="border rounded p-3 stats-card">
                                <div class="fs-1 mb-2">ğŸ¯</div>
                                <h4>@totalDiscount.ToString("N0")</h4>
                                <small class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙ…</small>
                            </div>
                        </div>
                        <div class="col-md-2 text-center mb-3">
                            <div class="border rounded p-3 stats-card">
                                <div class="fs-1 mb-2">ğŸ’³</div>
                                @{
                                    var lastTransaction = transactions.OrderByDescending(t => t.Date).FirstOrDefault();
                                }
                                @if (lastTransaction != null)
                                {
                                    <h4>@lastTransaction.Date.ToString("dd/MM")</h4>
                                    <small class="text-muted">@lastTransaction.Date.Year</small>
                                }
                                else
                                {
                                    <h4>-</h4>
                                    <small class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</small>
                                }
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden data for JavaScript -->
                    <div style="display: none;">
                        <span data-net-purchases="@netPurchases.ToString("N2")"></span>
                        <span data-actual-balance="@actualBalance.ToString("N2")"></span>
                    </div>
                    
                    @if (mostFrequentProduct != null)
                    {
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6>ğŸ† Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹</h6>
                                    <p class="mb-0"><strong>@mostFrequentProduct.Key</strong> - ØªÙ… Ø·Ù„Ø¨Ù‡ @mostFrequentProduct.Count() Ù…Ø±Ø©</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-section">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <label class="form-label">Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª:</label>
                        <input type="text" class="form-control search-box" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª...">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©:</label>
                        <div class="transaction-type-filter">
                            <button class="filter-btn active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
                            <button class="filter-btn" data-filter="sale">ğŸ›ï¸ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
                            <button class="filter-btn" data-filter="return">â†©ï¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</button>
                            <button class="filter-btn" data-filter="exchange">ğŸ”„ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ø§Øª</button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨:</label>
                        <select class="form-select" id="sortSelect">
                            <option value="date-desc">Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø«)</option>
                            <option value="date-asc">Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ù‚Ø¯Ù…)</option>
                            <option value="product-asc">Ø§Ù„Ù…Ù†ØªØ¬ (Ø£-ÙŠ)</option>
                            <option value="product-desc">Ø§Ù„Ù…Ù†ØªØ¬ (ÙŠ-Ø£)</option>
                            <option value="total-desc">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ù„Ø£ÙƒØ¨Ø±)</option>
                            <option value="total-asc">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ù„Ø£ØµØºØ±)</option>
                            <option value="remaining-desc">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø§Ù„Ø£ÙƒØ¨Ø±)</option>
                            <option value="remaining-asc">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø§Ù„Ø£ØµØºØ±)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <a href="#" onclick="printCustomerReport()" class="card text-decoration-none h-100 quick-action-card">
                <div class="card-body text-center">
                    <div class="fs-1 mb-2">ğŸ–¨ï¸</div>
                    <h6>Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h6>
                    <small class="text-muted">Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„</small>
                </div>
            </a>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card h-100 quick-action-card position-relative">
                <div class="card-body text-center" onclick="toggleExportOptions()">
                    <div class="fs-1 mb-2">ğŸ“Š</div>
                    <h6>ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h6>
                    <small class="text-muted">CSV, Excel, PDF</small>
                </div>
                <div class="export-options" id="exportOptions">
                    <a href="#" onclick="exportCustomerData('csv')">ğŸ“„ CSV</a>
                    <a href="#" onclick="exportCustomerData('excel')">ğŸ“Š Excel</a>
                    <a href="#" onclick="exportCustomerData('pdf')">ğŸ“‹ PDF</a>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <a asp-action="AddTransaction" asp-route-id="@Model.Id" class="card text-decoration-none h-100 quick-action-card">
                <div class="card-body text-center">
                    <div class="fs-1 mb-2">ğŸ’°</div>
                    <h6>Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø©</h6>
                    <small class="text-muted">Ø¨ÙŠØ¹ØŒ Ø¥Ø±Ø¬Ø§Ø¹ØŒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„</small>
                </div>
            </a>
        </div>
        <div class="col-md-3 mb-3">
            <a asp-action="Edit" asp-route-id="@Model.Id" class="card text-decoration-none h-100 quick-action-card">
                <div class="card-body text-center">
                    <div class="fs-1 mb-2">âœï¸</div>
                    <h6>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h6>
                    <small class="text-muted">ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</small>
                </div>
            </a>
        </div>
    </div>

    <!-- Transactions Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h5>
                    <span class="badge bg-primary" id="transactionsCount">@transactions.Count Ù…Ø¹Ø§Ù…Ù„Ø©</span>
                </div>
                <div class="card-body">
                    @if (transactions.Any())
                    {
                        <div class="table-container">
                            <table class="table table-hover" id="transactionsTable">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th class="sortable" data-sort="product">Ø§Ù„Ù…Ù†ØªØ¬</th>
                                        <th class="sortable" data-sort="quantity">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                        <th class="sortable" data-sort="price">Ø§Ù„Ø³Ø¹Ø±</th>
                                        <th class="sortable" data-sort="discount">Ø§Ù„Ø®ØµÙ…</th>
                                        <th class="sortable" data-sort="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                        <th class="sortable" data-sort="paid">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                                        <th class="sortable" data-sort="remaining">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var transaction in transactions.OrderByDescending(t => t.Date))
                                    {
                                        var isReturn = transaction.Quantity < 0;
                                        var isExchange = transaction.Notes?.Contains("Ø§Ø³ØªØ¨Ø¯Ø§Ù„") == true;
                                        var remaining = transaction.TotalPrice - transaction.AmountPaid;
                                        
                                        <tr class="@(isReturn ? "table-warning" : remaining > 0 ? "table-light" : "")" 
                                            data-type="@(isExchange ? "exchange" : isReturn ? "return" : "sale")"
                                            data-product="@(transaction.Product?.Name ?? "")"
                                            data-notes="@(transaction.Notes ?? "")">
                                            <td data-date="@transaction.Date.Ticks">@transaction.Date.ToString("dd/MM/yyyy")</td>
                                            <td>
                                                @if (transaction.Product != null)
                                                {
                                                    <span>@transaction.Product.Name</span>
                                                    @if (!string.IsNullOrEmpty(transaction.Product.Category?.Name))
                                                    {
                                                        <br><small class="text-muted">@transaction.Product.Category.Name</small>
                                                    }
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Ù…Ù†ØªØ¬ Ù…Ø­Ø°ÙˆÙ</span>
                                                }
                                            </td>
                                            <td data-quantity="@transaction.Quantity">
                                                <span class="@(isReturn ? "text-danger" : "text-success")">
                                                    @(isReturn ? "â†©ï¸" : "ğŸ“¦") @Math.Abs(transaction.Quantity)
                                                </span>
                                            </td>
                                            <td data-price="@transaction.Price">@transaction.Price.ToString("N2") Ø¬Ù†ÙŠÙ‡</td>
                                            <td data-discount="@transaction.Discount">@transaction.Discount.ToString("N2") Ø¬Ù†ÙŠÙ‡</td>
                                            <td data-total="@transaction.TotalPrice">@transaction.TotalPrice.ToString("N2") Ø¬Ù†ÙŠÙ‡</td>
                                            <td data-paid="@transaction.AmountPaid">@transaction.AmountPaid.ToString("N2") Ø¬Ù†ÙŠÙ‡</td>
                                            <td data-remaining="@remaining">
                                                <span class="@(remaining > 0 ? "text-danger" : remaining < 0 ? "text-success" : "text-muted")">
                                                    @remaining.ToString("N2") Ø¬Ù†ÙŠÙ‡
                                                </span>
                                            </td>
                                            <td>
                                                @if (isExchange)
                                                {
                                                    <span class="badge bg-warning">ğŸ”„ Ø§Ø³ØªØ¨Ø¯Ø§Ù„</span>
                                                }
                                                else if (isReturn)
                                                {
                                                    <span class="badge bg-danger">â†©ï¸ Ø¥Ø±Ø¬Ø§Ø¹</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-success">ğŸ›ï¸ Ø¨ÙŠØ¹</span>
                                                }
                                            </td>
                                            <td>
                                                <div class="btn-group-vertical btn-group-sm" role="group">
                                                    <a asp-action="EditTransaction" asp-route-id="@transaction.Id" 
                                                       class="btn btn-outline-warning btn-sm" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©">
                                                      
                                                    </a>
                                                    <form asp-action="DeleteTransaction" asp-route-id="@transaction.Id" 
                                                          method="post" class="d-inline" 
                                                          onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ')">
                                                        <button type="submit" class="btn btn-outline-danger btn-sm" title="Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©">
                                                         
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <div class="fs-1 mb-3">ğŸ“‹</div>
                            <h4>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h4>
                            <p class="text-muted">Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¹Ø¯.</p>
                            <a asp-action="AddTransaction" asp-route-id="@Model.Id" class="btn btn-primary">
                                ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ù…Ø¹Ø§Ù…Ù„Ø©
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript for Customers Details page is now in site.js
// The page will automatically initialize when loaded
</script>
