@model PesticideShop.Models.CustomerTransaction

@{
    ViewData["Title"] = "Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø©";
    var customerId = ViewData["CustomerId"] as int? ?? Model?.CustomerId ?? 0;
    var customerName = ViewData["CustomerName"] as string;
    var customerPhone = ViewData["CustomerPhone"] as string;
    var productList = ViewData["ProductId"] as Microsoft.AspNetCore.Mvc.Rendering.SelectList;
}

<div class="fade-in">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>âœ… ØªÙ… Ø¨Ù†Ø¬Ø§Ø­:</strong> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>âš ï¸ Ø®Ø·Ø£:</strong> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (string.IsNullOrWhiteSpace(customerPhone))
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>âš ï¸ ØªÙ†Ø¨ÙŠÙ‡:</strong> Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø§ ÙŠÙ…Ù„Ùƒ Ø±Ù‚Ù… Ù‡Ø§ØªÙ. Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ ÙÙˆØ§ØªÙŠØ± Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨.
            <a asp-action="Edit" asp-route-id="@customerId" class="btn btn-sm btn-warning ms-2">Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ù‡Ø§ØªÙ</a>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>ğŸ’° Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø©</h1>
            <p class="text-muted mb-0">ØªØ³Ø¬ÙŠÙ„ Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„ @customerName</p>
            @if (!string.IsNullOrWhiteSpace(customerPhone))
            {
                <small class="text-muted">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: @customerPhone</small>
            }
        </div>
        <a asp-action="Details" asp-route-id="@customerId" class="btn btn-secondary">
            â† Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„
        </a>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ @customerName</h5>
                </div>
                <div class="card-body">
                    <form asp-action="AddTransaction" asp-route-id="@customerId" method="post" id="transactionForm" enctype="multipart/form-data">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                        
                        <input type="hidden" name="CustomerId" value="@customerId" />
                        <input type="hidden" asp-for="CustomerId" value="@customerId" />
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="ProductId" class="form-label">Ø§Ù„Ù…Ù†ØªØ¬ *</label>
                                <select asp-for="ProductId" asp-items="productList" class="form-select" required id="productSelect" name="ProductId">
                                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ --</option>
                                </select>
                                <span asp-validation-for="ProductId" class="text-danger"></span>
                                <div id="productInfo" class="mt-2" style="display: none;">
                                    <small class="text-muted">
                                        Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©: <span id="availableQuantity" class="fw-bold"></span> Ù‚Ø·Ø¹Ø©
                                    </small>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label asp-for="Quantity" class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ© *</label>
                                <input asp-for="Quantity" type="number" min="1" class="form-control" required id="quantityInput" name="Quantity" />
                                <span asp-validation-for="Quantity" class="text-danger"></span>
                                <div id="quantityWarning" class="mt-2" style="display: none;">
                                    <small class="text-danger">
                                        âš ï¸ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©!
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="TotalPrice" class="form-label">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input asp-for="TotalPrice" type="number" step="0.01" min="0" class="form-control" required name="TotalPrice" />
                                </div>
                                <span asp-validation-for="TotalPrice" class="text-danger"></span>
                                <small class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label asp-for="AmountPaid" class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input asp-for="AmountPaid" type="number" step="0.01" min="0" class="form-control" required name="AmountPaid" />
                                </div>
                                <span asp-validation-for="AmountPaid" class="text-danger"></span>
                                <small class="text-muted">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ Ø¯ÙØ¹Ù‡ Ø§Ù„Ø¹Ù…ÙŠÙ„</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Date" class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© *</label>
                                <input asp-for="Date" type="date" class="form-control" required value="@DateTime.Now.ToString("yyyy-MM-dd")" name="Date" />
                                <span asp-validation-for="Date" class="text-danger"></span>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="text" id="remainingBalance" class="form-control" readonly />
                                </div>
                                <small class="text-muted">ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</small>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-success" id="submitBtn" onclick="return validateForm()">
                                ğŸ’° Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
                            </button>
                            <a asp-action="Details" asp-route-id="@customerId" class="btn btn-secondary">
                                Ø¥Ù„ØºØ§Ø¡
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ“‹ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6>ÙƒÙŠÙÙŠØ© Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø©:</h6>
                        <ol class="mb-0">
                            <li>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø°ÙŠ Ø§Ø´ØªØ±Ø§Ù‡ Ø§Ù„Ø¹Ù…ÙŠÙ„</li>
                            <li>Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±Ø§Ø© (Ø³ÙŠØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)</li>
                            <li>Ø­Ø¯Ø¯ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</li>
                            <li>Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ Ø¯ÙØ¹Ù‡ Ø§Ù„Ø¹Ù…ÙŠÙ„</li>
                            <li>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</li>
                        </ol>
                    </div>
                    
                    <div class="alert alert-warning">
                        <h6>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©:</h6>
                        <ul class="mb-0">
                            <li>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ = Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ã— Ø§Ù„ÙƒÙ…ÙŠØ©</li>
                            <li>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ = Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ - Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</li>
                            <li>Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ = Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØŒ ÙŠÙƒÙˆÙ† Ø§Ù„Ø±ØµÙŠØ¯ $0</li>
                            <li>ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø§Øª Ø¬Ø²Ø¦ÙŠØ© Ù„Ø§Ø­Ù‚Ù‹Ø§</li>
                            <li>Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„ÙƒÙ…ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ù†ØªØ¬</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Product data for quantity checking
const productData = @Html.Raw(Json.Serialize(ViewData["ProductData"] ?? new Dictionary<string, object>()));

// Auto-calculate remaining balance
document.addEventListener('DOMContentLoaded', function() {
    const totalPriceInput = document.querySelector('input[name="TotalPrice"]');
    const amountPaidInput = document.querySelector('input[name="AmountPaid"]');
    const remainingBalanceInput = document.getElementById('remainingBalance');
    const productSelect = document.getElementById('productSelect');
    const quantityInput = document.getElementById('quantityInput');
    const productInfo = document.getElementById('productInfo');
    const availableQuantity = document.getElementById('availableQuantity');
    const quantityWarning = document.getElementById('quantityWarning');
    const submitBtn = document.getElementById('submitBtn');
    
    function calculateRemaining() {
        const totalPrice = parseFloat(totalPriceInput.value) || 0;
        const discount = parseFloat(document.querySelector('input[name="Discount"]')?.value || 0);
        const amountPaid = parseFloat(amountPaidInput.value) || 0;
        const actualTotal = totalPrice - discount;
        const remaining = actualTotal - amountPaid;
        
        remainingBalanceInput.value = remaining.toFixed(2);
        
        if (remaining > 0) {
            remainingBalanceInput.classList.add('text-danger', 'fw-bold');
            remainingBalanceInput.classList.remove('text-success');
        } else {
            remainingBalanceInput.classList.add('text-success');
            remainingBalanceInput.classList.remove('text-danger', 'fw-bold');
        }
    }
    
    function checkQuantity() {
        const selectedOption = productSelect.options[productSelect.selectedIndex];
        if (selectedOption && selectedOption.value) {
            // Extract product info from display name (format: "Product Name - $XX.XX (Qty: XX)")
            const displayText = selectedOption.text;
            const qtyMatch = displayText.match(/Qty: (\d+)/);
            const availableQty = qtyMatch ? parseInt(qtyMatch[1]) : 0;
            const requestedQty = parseInt(quantityInput.value) || 0;
            
            availableQuantity.textContent = availableQty;
            productInfo.style.display = 'block';
            
            if (requestedQty > availableQty && requestedQty > 0) {
                quantityWarning.style.display = 'block';
                submitBtn.disabled = true;
                submitBtn.classList.add('btn-secondary');
                submitBtn.classList.remove('btn-success');
            } else {
                quantityWarning.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.classList.add('btn-success');
                submitBtn.classList.remove('btn-secondary');
            }
        } else {
            productInfo.style.display = 'none';
            quantityWarning.style.display = 'none';
            submitBtn.disabled = false;
            submitBtn.classList.add('btn-success');
            submitBtn.classList.remove('btn-secondary');
        }
    }
    
    function calculateTotalPrice() {
        const selectedOption = productSelect.options[productSelect.selectedIndex];
        if (selectedOption && selectedOption.value) {
            // Extract price from display name (format: "Product Name - $XX.XX (Qty: XX)")
            const displayText = selectedOption.text;
            const priceMatch = displayText.match(/\$(\d+\.?\d*)/);
            const unitPrice = priceMatch ? parseFloat(priceMatch[1]) : 0;
            const quantity = parseFloat(quantityInput.value) || 0;
            const totalPrice = unitPrice * quantity;
            totalPriceInput.value = totalPrice.toFixed(2);
            calculateRemaining();
        }
    }
    
    totalPriceInput.addEventListener('input', calculateRemaining);
    amountPaidInput.addEventListener('input', calculateRemaining);
    productSelect.addEventListener('change', function() {
        calculateTotalPrice();
        checkQuantity();
    });
    quantityInput.addEventListener('input', function() {
        calculateTotalPrice();
        checkQuantity();
    });
    
    // Validation function
    function validateForm() {
        const productId = document.querySelector('select[name="ProductId"]').value;
        const quantity = document.querySelector('input[name="Quantity"]').value;
        const totalPrice = document.querySelector('input[name="TotalPrice"]').value;
        const amountPaid = document.querySelector('input[name="AmountPaid"]').value;
        const date = document.querySelector('input[name="Date"]').value;
        const customerId = document.querySelector('input[name="CustomerId"]').value;
        
        if (!productId) {
            alert('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬');
            return false;
        }
        
        if (!quantity || quantity <= 0) {
            alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©');
            return false;
        }
        
        if (!totalPrice || totalPrice <= 0) {
            alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµØ­ÙŠØ­');
            return false;
        }
        
        if (!amountPaid || amountPaid < 0) {
            alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº Ù…Ø¯ÙÙˆØ¹ ØµØ­ÙŠØ­');
            return false;
        }
        
        if (!date) {
            alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ® ØµØ­ÙŠØ­');
            return false;
        }
        
        // Log form data for debugging
        console.log('Form validation passed with data:', {
            CustomerId: customerId,
            ProductId: productId,
            Quantity: quantity,
            TotalPrice: totalPrice,
            AmountPaid: amountPaid,
            Date: date
        });
        
        return true;
    }
    
    // Form submission handler
    const form = document.getElementById('transactionForm');
    form.addEventListener('submit', function(e) {
        // Basic client-side validation
        const productId = document.querySelector('select[name="ProductId"]').value;
        const quantity = document.querySelector('input[name="Quantity"]').value;
        const totalPrice = document.querySelector('input[name="TotalPrice"]').value;
        const amountPaid = document.querySelector('input[name="AmountPaid"]').value;
        const date = document.querySelector('input[name="Date"]').value;
        const customerId = document.querySelector('input[name="CustomerId"]').value;
        
        if (!productId) {
            alert('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬');
            e.preventDefault();
            return false;
        }
        
        if (!quantity || quantity <= 0) {
            alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©');
            e.preventDefault();
            return false;
        }
        
        if (!totalPrice || totalPrice <= 0) {
            alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµØ­ÙŠØ­');
            e.preventDefault();
            return false;
        }
        
        if (!amountPaid || amountPaid < 0) {
            alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº Ù…Ø¯ÙÙˆØ¹ ØµØ­ÙŠØ­');
            e.preventDefault();
            return false;
        }
        
        if (!date) {
            alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ® ØµØ­ÙŠØ­');
            e.preventDefault();
            return false;
        }
        
        // Ensure submit button is enabled
        submitBtn.disabled = false;
        submitBtn.classList.add('btn-success');
        submitBtn.classList.remove('btn-secondary');
        
        // Add loading state
        submitBtn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        submitBtn.disabled = true;
        
        // Log form data for debugging
      );
});
</script>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
} 