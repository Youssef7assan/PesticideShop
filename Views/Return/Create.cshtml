@model PesticideShop.Controllers.ReturnRequest

@{
    ViewData["Title"] = "Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ù†ØªØ¬";
    var products = ViewBag.Products as List<PesticideShop.Models.Product>;
    var originalInvoiceNumber = ViewBag.OriginalInvoiceNumber as string;
}

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-gradient-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-0">
                                <i class="fas fa-undo"></i>
                                Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ù†ØªØ¬
                            </h2>
                            <p class="mb-0 opacity-75">Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ ÙØ§ØªÙˆØ±Ø© Ø³Ø§Ø¨Ù‚Ø©</p>
                        </div>
                        <div>
                            @if (!string.IsNullOrEmpty(originalInvoiceNumber))
                            {
                                <a href="@Url.Action("MultiReturn", "Return")" 
                                   class="btn btn-success me-2" 
                                   id="multiReturnBtn"
                                   title="Ø¥Ø±Ø¬Ø§Ø¹ Ø¹Ø¯Ø© Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
                                    <i class="fas fa-undo-alt"></i> Ø¥Ø±Ø¬Ø§Ø¹ Ù…ØªØ¹Ø¯Ø¯
                                </a>
                            }
                            <a href="@Url.Action("Index", "Return")" class="btn btn-light me-2">
                                ğŸ“‹ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
                            </a>
                            <a href="@Url.Action("Index", "Invoices")" class="btn btn-light">
                                â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙÙˆØ§ØªÙŠØ±
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form asp-action="Create" method="post" id="returnForm">
        <div class="row">
            <!-- Return Form -->
            <div class="col-md-8">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                           
                            Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Original Invoice -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="OriginalInvoiceNumber" class="form-label">
                                    <i class="fas fa-file-invoice"></i>
                                    Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© *
                                </label>
                                <div class="input-group">
                                    <input asp-for="OriginalInvoiceNumber" class="form-control" 
                                           placeholder="Ù…Ø«Ø§Ù„: INV-20241225-001" 
                                           value="@originalInvoiceNumber" />
                                    <button type="button" id="loadInvoiceBtn" class="btn btn-outline-primary">
                                        ğŸ” ØªØ­Ù…ÙŠÙ„
                                    </button>
                                </div>
                                <span asp-validation-for="OriginalInvoiceNumber" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">
                                   
                                    Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ *
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-danger text-white">RTN</span>
                                    <input type="text" id="returnInvoiceNumber" class="form-control" 
                                           placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø±Ù‚Ù…..." 
                                           maxlength="20" />
                                </div>
                                <small class="form-text text-muted">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹: RTN + Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø°ÙŠ ØªØ¯Ø®Ù„Ù‡</small>
                            </div>
                        </div>
                        
                        <!-- Invoice Status -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div id="invoiceStatus">
                                    <!-- Invoice status will be shown here -->
                                </div>
                            </div>
                        </div>

                        <!-- Product Selection -->
                        <div class="row mb-3" id="productSection" style="display: none;">
                            <div class="col-md-6">
                                <label asp-for="ProductId" class="form-label">
                                  
                                    Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø±Ø¬Ø§Ø¹Ù‡ *
                                </label>
                                <select asp-for="ProductId" class="form-select" id="productSelect">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬...</option>
                                    <!-- Options will be loaded dynamically -->
                                </select>
                                <span asp-validation-for="ProductId" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="ReturnedQuantity" class="form-label">
                                    
                                    Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø±Ø¬Ø§Ø¹Ù‡Ø§ *
                                </label>
                                <input asp-for="ReturnedQuantity" type="number" class="form-control" 
                                       min="1" placeholder="1" />
                                <span asp-validation-for="ReturnedQuantity" class="text-danger"></span>
                                <small class="form-text text-muted" id="availableQuantityText"></small>
                            </div>
                        </div>

                        <!-- Return Reason -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label asp-for="ReturnReason" class="form-label">
                                   
                                    Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
                                </label>
                                <select asp-for="ReturnReason" class="form-select">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¨Ø¨...</option>
                                    <option value="Ø¹ÙŠØ¨ ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬">Ø¹ÙŠØ¨ ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬</option>
                                    <option value="Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù…ÙˆØ§ØµÙØ§Øª">Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù…ÙˆØ§ØµÙØ§Øª</option>
                                    <option value="ØªØ£Ø®ÙŠØ± ÙÙŠ Ø§Ù„ØªØ³Ù„ÙŠÙ…">ØªØ£Ø®ÙŠØ± ÙÙŠ Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
                                    <option value="Ø·Ù„Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„">Ø·Ù„Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
                                    <option value="Ù…Ù†ØªØ¬ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©">Ù…Ù†ØªØ¬ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</option>
                                    <option value="ØªÙ„Ù Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ù‚Ù„">ØªÙ„Ù Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ù‚Ù„</option>
                                    <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                                </select>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label asp-for="Notes" class="form-label">
                                 
                                    Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
                                </label>
                                <textarea asp-for="Notes" class="form-control" rows="3" 
                                          placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø­ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹..."></textarea>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-danger" id="submitBtn">
                                        âœ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
                                    </button>
                                    <button type="reset" class="btn btn-outline-secondary">
                                        ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
                                    </button>
                                    <a href="@Url.Action("Index", "Invoices")" class="btn btn-outline-danger">
                                        âŒ Ø¥Ù„ØºØ§Ø¡
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Panel -->
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="returnSummary">
                            <div class="text-center text-muted">
                                <p>Ù‚Ù… Ø¨Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ù„Ø®Øµ</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Return Rules -->
                <div class="card border-0 shadow-sm mt-3">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
                        </h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© ÙÙ‚Ø·
                            </li>
                            <li class="mb-2">
                                ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
                            </li>
                            <li class="mb-2">
                                ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                            </li>
                            <li class="mb-2">
                                ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¥Ø±Ø¬Ø§Ø¹ Ø¬Ø¯ÙŠØ¯Ø©
                            </li>
                            <li class="mb-0">
                                Ø³ÙŠØªÙ… Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ø¹Ù…ÙŠÙ„
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
.bg-gradient-danger {
    background: linear-gradient(45deg, #dc3545, #c82333) !important;
}

.opacity-75 {
    opacity: 0.75;
}

.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
}

.form-label {
    font-weight: 600;
    color: #495057;
}

.form-label i {
    margin-right: 5px;
    color: #6c757d;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const originalInvoiceInput = document.querySelector('[name="OriginalInvoiceNumber"]');
    const loadInvoiceBtn = document.getElementById('loadInvoiceBtn');
    const productSelect = document.getElementById('productSelect');
    const quantityInput = document.querySelector('[name="ReturnedQuantity"]');
    const productSection = document.getElementById('productSection');
    const invoiceStatus = document.getElementById('invoiceStatus');
    const returnSummary = document.getElementById('returnSummary');
    const returnInvoiceNumberInput = document.getElementById('returnInvoiceNumber');

    let invoiceItems = [];

    // Generate return invoice number automatically
    function generateReturnInvoiceNumber() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const time = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
        
        // Generate a unique number based on timestamp
        const uniqueNumber = `${year}${month}${day}${time}`;
        
        // Set the input value
        returnInvoiceNumberInput.value = uniqueNumber;
        
        // Show preview
        showReturnInvoicePreview();
    }

    // Show return invoice number preview
    function showReturnInvoicePreview() {
        const userInput = returnInvoiceNumberInput.value.trim();
        if (userInput) {
            const fullNumber = `RTN${userInput}`;
            const preview = document.getElementById('returnInvoicePreview');
            if (preview) {
                preview.textContent = `Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙƒØ§Ù…Ù„: ${fullNumber}`;
            } else {
                // Create preview element if it doesn't exist
                const previewElement = document.createElement('small');
                previewElement.id = 'returnInvoicePreview';
                previewElement.className = 'form-text text-danger fw-bold';
                previewElement.textContent = `Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙƒØ§Ù…Ù„: ${fullNumber}`;
                returnInvoiceNumberInput.parentNode.parentNode.appendChild(previewElement);
            }
        } else {
            const preview = document.getElementById('returnInvoicePreview');
            if (preview) {
                preview.remove();
            }
        }
    }

    // Auto-generate return invoice number on page load
    generateReturnInvoiceNumber();

    // Update preview when user types
    returnInvoiceNumberInput.addEventListener('input', showReturnInvoicePreview);

    // Load invoice items
    loadInvoiceBtn.addEventListener('click', async function() {
        const invoiceNumber = originalInvoiceInput.value.trim();
        
        if (!invoiceNumber) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©');
            return;
        }

        try {
            loadInvoiceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            loadInvoiceBtn.disabled = true;

            const response = await fetch(`/Return/GetInvoiceItems?invoiceNumber=${encodeURIComponent(invoiceNumber)}`);
            const data = await response.json();

            if (data.success) {
                invoiceItems = data.items;
                populateProductSelect();
                productSection.style.display = 'block';
                invoiceStatus.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ (${data.items.length} Ù…Ù†ØªØ¬)
                    </div>
                `;
            } else {
                invoiceStatus.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        ${data.message}
                    </div>
                `;
                productSection.style.display = 'none';
            }
        } catch (error) {
            invoiceStatus.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                </div>
            `;
        } finally {
            loadInvoiceBtn.innerHTML = '<i class="fas fa-search"></i> ØªØ­Ù…ÙŠÙ„';
            loadInvoiceBtn.disabled = false;
        }
    });

    // Populate product select
    function populateProductSelect() {
        productSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬...</option>';
        
        invoiceItems.forEach(item => {
            if (item.canReturn) {
                const option = document.createElement('option');
                option.value = item.productId;
                
                // Build display text with color information
                let displayText = `${item.productName}`;
                if (item.color && item.color.trim() !== '') {
                    displayText += ` - ğŸ¨ ${item.color}`;
                }
                if (item.size && item.size.trim() !== '') {
                    displayText += ` - ğŸ“ ${item.size}`;
                }
                displayText += ` - ${item.unitPrice.toFixed(2)} Ø¬.Ù… (Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.quantity})`;
                
                option.textContent = displayText;
                option.dataset.maxQuantity = item.quantity;
                productSelect.appendChild(option);
            }
        });
    }

    // Update available quantity
    productSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const maxQuantity = selectedOption.dataset.maxQuantity;
            quantityInput.max = maxQuantity;
            quantityInput.value = Math.min(quantityInput.value || 1, maxQuantity);
            document.getElementById('availableQuantityText').textContent = 
                `Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: ${maxQuantity} Ù‚Ø·Ø¹Ø©`;
            updateReturnSummary();
        } else {
            document.getElementById('availableQuantityText').textContent = '';
            updateReturnSummary();
        }
    });

    // Update return summary
    quantityInput.addEventListener('input', updateReturnSummary);

    function updateReturnSummary() {
        const productOption = productSelect.options[productSelect.selectedIndex];
        const quantity = parseInt(quantityInput.value) || 0;

        if (productOption.value && quantity > 0) {
            returnSummary.innerHTML = `
                <div class="summary-item mb-3">
                    <h6 class="text-danger">Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø±ØªØ¬Ø¹:</h6>
                    <p class="mb-1">${productOption.textContent}</p>
                    <small class="text-muted">Ø§Ù„ÙƒÙ…ÙŠØ©: ${quantity}</small>
                </div>
                <hr>
                <div class="summary-item">
                    <h6>Ù…Ù„Ø§Ø­Ø¸Ø©:</h6>
                    <p class="mb-0 text-muted">
                        Ø³ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ø¹Ù…ÙŠÙ„
                    </p>
                </div>
            `;
        } else {
            returnSummary.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                    <p>Ù‚Ù… Ø¨Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ù„Ø®Øµ</p>
                </div>
            `;
        }
    }

    // Auto-load if original invoice number is provided
    if (originalInvoiceInput.value) {
        loadInvoiceBtn.click();
    }

    // Handle form submission
    document.getElementById('returnForm').addEventListener('submit', function(e) {
        const userInput = returnInvoiceNumberInput.value.trim();
        if (!userInput) {
            e.preventDefault();
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹');
            returnInvoiceNumberInput.focus();
            return;
        }

        // Create hidden input with full return invoice number
        const fullReturnNumber = `RTN${userInput}`;
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'ReturnInvoiceNumber';
        hiddenInput.value = fullReturnNumber;
        this.appendChild(hiddenInput);

        // Show confirmation
        if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø±Ø¬Ø§Ø¹ Ø¨Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${fullReturnNumber}ØŸ`)) {
            e.preventDefault();
            return;
        }
    });

    // Multi-return button: transfer invoice number to MultiReturn page
    const multiReturnBtn = document.getElementById('multiReturnBtn');
    if (multiReturnBtn) {
        multiReturnBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const invoiceNumber = document.querySelector('[name="OriginalInvoiceNumber"]').value;
            
            if (invoiceNumber) {
                // Store invoice number in sessionStorage
                sessionStorage.setItem('multiReturnInvoiceNumber', invoiceNumber);
                window.location.href = this.href;
            } else {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹');
            }
        });
    }
});
</script>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
